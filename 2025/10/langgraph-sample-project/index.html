<!DOCTYPE html>
<html class="no-js" lang="en"> <head><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1" name="viewport"/><meta content="Bin Zhang" name="author"/><link href="http://binzhango.github.io/2025/10/langgraph-sample-project/" rel="canonical"/><link href="../../09/langchainlanggraph-qa/" rel="prev"/><link href="../langgraph-reflection/" rel="next"/><link href="../../../assets/favicon.ico" rel="icon"/><meta content="mkdocs-1.6.1, mkdocs-material-9.6.9" name="generator"/><title>LangGraph Sample Project - B~~~~~Z</title><link href="../../../assets/stylesheets/main.4af4bdda.min.css" rel="stylesheet"/><link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/><link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/><style>:root{--md-text-font:"Roboto";--md-code-font:"Fira Code"}</style><link href="../../../stylesheets/extra.css" rel="stylesheet"/><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-HLMVZHNEWM"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-HLMVZHNEWM",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-HLMVZHNEWM",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><meta content="website" property="og:type"/><meta content="LangGraph Sample Project - B~~~~~Z" property="og:title"/><meta content="None" property="og:description"/><meta content="http://binzhango.github.io/assets/images/social/posts/2025/10-02-LangChain.png" property="og:image"/><meta content="image/png" property="og:image:type"/><meta content="1200" property="og:image:width"/><meta content="630" property="og:image:height"/><meta content="http://binzhango.github.io/2025/10/langgraph-sample-project/" property="og:url"/><meta content="summary_large_image" name="twitter:card"/><meta content="LangGraph Sample Project - B~~~~~Z" name="twitter:title"/><meta content="None" name="twitter:description"/><meta content="http://binzhango.github.io/assets/images/social/posts/2025/10-02-LangChain.png" name="twitter:image"/> <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></link></head> <body data-md-color-accent="indigo" data-md-color-primary="amber" data-md-color-scheme="default" dir="ltr"> <input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/> <input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a class="md-skip" href="#langgraph-sample-project"> Skip to content </a> </div> <div data-md-component="announce"> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component="header"> <nav aria-label="Header" class="md-header__inner md-grid"> <a aria-label="B~~~~~Z" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="B~~~~~Z"> <img alt="logo" src="../../../assets/favicon.ico"/> </a> <label class="md-header__button md-icon" for="__drawer"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> B~~~~~Z </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> LangGraph Sample Project </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input aria-label="Dark Mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="amber" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_1" hidden="" title="Dark Mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg> </label> <input aria-label="Light Mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="blue-grey" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_0" hidden="" title="Light Mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/> <label class="md-search__icon md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </label> <nav aria-label="Search" class="md-search__options"> <a aria-label="Share" class="md-search__icon md-icon" data-clipboard="" data-clipboard-text="" data-md-component="search-share" href="javascript:void(0)" tabindex="-1" title="Share"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"></path></svg> </a> <button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg> </button> </nav> <div class="md-search__suggest" data-md-component="search-suggest"></div> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0"> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> Initializing search </div> <ol class="md-search-result__list" role="presentation"></ol> </div> </div> </div> </div> </div> <div class="md-header__source"> <a class="md-source" data-md-component="source" href="https://github.com/binzhango/binzhango.github.io" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg> </div> <div class="md-source__repository"> binzhango/binzhango.github.io </div> </a> </div> </nav> <nav aria-label="Tabs" class="md-tabs" data-md-component="tabs"> <div class="md-grid"> <ul class="md-tabs__list"> <li class="md-tabs__item md-tabs__item--active"> <a class="md-tabs__link" href="../../.."> Blog </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../"> Archive </a> </li> <li class="md-tabs__item"> <a class="md-tabs__link" href="../../../category/azure/"> Categories </a> </li> </ul> </div> </nav> </header> <div class="md-container" data-md-component="container"> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden=""> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a aria-label="B~~~~~Z" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="B~~~~~Z"> <img alt="logo" src="../../../assets/favicon.ico"/> </a> B~~~~~Z </label> <div class="md-nav__source"> <a class="md-source" data-md-component="source" href="https://github.com/binzhango/binzhango.github.io" title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg> </div> <div class="md-source__repository"> binzhango/binzhango.github.io </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item md-nav__item--active"> <a class="md-nav__link" href="../../.."> <span class="md-ellipsis"> Blog </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_2" type="checkbox"/> <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0"> <span class="md-ellipsis"> Archive </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_2"> <span class="md-nav__icon md-icon"></span> Archive </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../"> <span class="md-ellipsis"> 2025 </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../2024/"> <span class="md-ellipsis"> 2024 </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../2021/"> <span class="md-ellipsis"> 2021 </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../2020/"> <span class="md-ellipsis"> 2020 </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../2012/"> <span class="md-ellipsis"> 2012 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox"/> <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0"> <span class="md-ellipsis"> Categories </span> <span class="md-nav__icon md-icon"></span> </label> <nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_3"> <span class="md-nav__icon md-icon"></span> Categories </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../../category/azure/"> <span class="md-ellipsis"> Azure </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../category/llm/"> <span class="md-ellipsis"> LLM </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../category/ml/"> <span class="md-ellipsis"> ML </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../category/scala/"> <span class="md-ellipsis"> Scala </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../category/snowflake/"> <span class="md-ellipsis"> Snowflake </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../category/airflow/"> <span class="md-ellipsis"> airflow </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../category/k8s/"> <span class="md-ellipsis"> k8s </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../category/python/"> <span class="md-ellipsis"> python </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../../category/spark/"> <span class="md-ellipsis"> spark </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-content md-content--post" data-md-component="content"> <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner md-post"> <nav class="md-nav md-nav--primary"> <div class="md-post__back"> <div class="md-nav__title md-nav__container"> <a class="md-nav__link" href="../../.."> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> <span class="md-ellipsis"> Back to index </span> </a> </div> </div> <div class="md-post__authors md-typeset"> <div class="md-profile md-post__profile"> <span class="md-author md-author--long"> <img alt="Bin Zhang" src="../../../assets/favicon.ico"/> </span> <span class="md-profile__description"> <strong> Bin Zhang </strong> <br/> Data Engineer </span> </div> </div> <ul class="md-post__meta md-nav__list"> <li class="md-nav__item md-nav__item--section"> <div class="md-post__title"> <span class="md-ellipsis"> Metadata </span> </div> <nav class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <div class="md-nav__link"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"></path></svg> <time class="md-ellipsis" datetime="2025-10-02 00:00:00+00:00">October 2, 2025</time> </div> </li> <li class="md-nav__item"> <div class="md-nav__link"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"></path></svg> <span class="md-ellipsis"> in <a href="../../../category/llm/">LLM</a></span> </div> </li> <li class="md-nav__item"> <div class="md-nav__link"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"></path></svg> <span class="md-ellipsis"> 19 min read </span> </div> </li> </ul> </nav> </li> </ul> </nav> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="#objective"> <span class="md-ellipsis"> Objective </span> </a> <nav aria-label="Objective" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#project-structure"> <span class="md-ellipsis"> Project Structure </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#services"> <span class="md-ellipsis"> Services </span> </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#codes-explanation"> <span class="md-ellipsis"> Codes Explanation </span> </a> </li> </ul> </nav> </div> </div> </div> <article class="md-content__inner md-typeset"> <div><h1 id="langgraph-sample-project">LangGraph Sample Project<a class="headerlink" href="#langgraph-sample-project" title="Permanent link">#</a></h1> <h2 id="objective">Objective<a class="headerlink" href="#objective" title="Permanent link">#</a></h2> <ul class="task-list"> <li class="task-list-item"><label class="task-list-control"><input checked="" disabled="" type="checkbox"/><span class="task-list-indicator"></span></label> <strong>Independent deployable services</strong></li> <li>Each agent can scale horizontally (e.g., analysis_service replicas)</li> <li> <p>You can version and deploy agents independently</p> </li> <li class="task-list-item"> <p><label class="task-list-control"><input checked="" disabled="" type="checkbox"/><span class="task-list-indicator"></span></label> <strong>Schema isolation</strong></p> <ul> <li>Each service defines its own <code>Pydantic</code> input/output</li> <li>Supervisor does schema translation</li> </ul> </li> <li class="task-list-item"> <p><label class="task-list-control"><input checked="" disabled="" type="checkbox"/><span class="task-list-indicator"></span></label> <strong>Resilience</strong></p> <ul> <li>Supervisor can retry subgraph calls, add timeout handling</li> </ul> </li> <li class="task-list-item"> <p><label class="task-list-control"><input checked="" disabled="" type="checkbox"/><span class="task-list-indicator"></span></label> <strong>Observability</strong></p> <ul> <li>You can trace inter-agent calls via <code>httpx</code> middleware or <code>OpenTelemetry</code></li> </ul> </li> <li class="task-list-item"> <p><label class="task-list-control"><input checked="" disabled="" type="checkbox"/><span class="task-list-indicator"></span></label> <strong>Extensible</strong></p> <ul> <li>Just add new agents (summarizer_service, retriever_service, etc.)</li> <li>Supervisor graph can grow dynamically without coupling</li> </ul> </li> </ul> <h3 id="project-structure">Project Structure<a class="headerlink" href="#project-structure" title="Permanent link">#</a></h3> <p>🎯 What's Included:</p> <ul> <li><strong>3 Independent Services:</strong><ul> <li>Research Service (Port <strong>8081</strong>) - Handles research queries with validation, planning, gathering, and summarization</li> <li>Analysis Service (Port <strong>8082</strong>) - Extracts insights, generates recommendations, and creates analysis reports</li> <li>Supervisor Service (Port <strong>8080</strong>) - Orchestrates the entire workflow via REST API calls</li> </ul> </li> <li> <p><strong>Key Features:</strong></p> <ul> <li>✅ Independent LangGraph workflows in each service</li> <li>✅ Shared error handler with per-node retry tracking</li> <li>✅ REST API communication between services</li> <li>✅ Parallel node support - no state conflicts</li> <li>✅ Docker deployment ready with docker-compose</li> <li>✅ Health checks for monitoring</li> <li>✅ Comprehensive error handling with automatic retries</li> <li>✅ Test scripts for validation</li> </ul> </li> </ul> <div class="language-sh highlight"><span class="filename">Microservice-style LangGraph architecture</span><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>agentic_system/
</span><span id="__span-0-2"><a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>├──<span class="w"> </span>shared/
</span><span id="__span-0-3"><a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>│<span class="w">   </span>└──<span class="w"> </span>error_handler.py<span class="w">          </span><span class="c1"># Shared error handling logic</span>
</span><span id="__span-0-4"><a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>│
</span><span id="__span-0-5"><a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>├──<span class="w"> </span>research_service/
</span><span id="__span-0-6"><a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>│<span class="w">   </span>├──<span class="w"> </span>main.py<span class="w">                    </span><span class="c1"># FastAPI app</span>
</span><span id="__span-0-7"><a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>│<span class="w">   </span>├──<span class="w"> </span>schema.py<span class="w">                  </span><span class="c1"># Pydantic models</span>
</span><span id="__span-0-8"><a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>│<span class="w">   </span>├──<span class="w"> </span>graph.py<span class="w">                   </span><span class="c1"># LangGraph workflow</span>
</span><span id="__span-0-9"><a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>│<span class="w">   </span>├──<span class="w"> </span>requirements.txt
</span><span id="__span-0-10"><a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>│<span class="w">   </span>└──<span class="w"> </span>Dockerfile
</span><span id="__span-0-11"><a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>│
</span><span id="__span-0-12"><a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>├──<span class="w"> </span>analysis_service/
</span><span id="__span-0-13"><a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>│<span class="w">   </span>├──<span class="w"> </span>main.py<span class="w">                    </span><span class="c1"># FastAPI app</span>
</span><span id="__span-0-14"><a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>│<span class="w">   </span>├──<span class="w"> </span>schema.py<span class="w">                  </span><span class="c1"># Pydantic models</span>
</span><span id="__span-0-15"><a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>│<span class="w">   </span>├──<span class="w"> </span>graph.py<span class="w">                   </span><span class="c1"># LangGraph workflow</span>
</span><span id="__span-0-16"><a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>│<span class="w">   </span>├──<span class="w"> </span>requirements.txt
</span><span id="__span-0-17"><a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>│<span class="w">   </span>└──<span class="w"> </span>Dockerfile
</span><span id="__span-0-18"><a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>│
</span><span id="__span-0-19"><a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>├──<span class="w"> </span>supervisor_service/
</span><span id="__span-0-20"><a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>│<span class="w">   </span>├──<span class="w"> </span>main.py<span class="w">                    </span><span class="c1"># FastAPI app</span>
</span><span id="__span-0-21"><a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>│<span class="w">   </span>├──<span class="w"> </span>schema.py<span class="w">                  </span><span class="c1"># Pydantic models</span>
</span><span id="__span-0-22"><a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a>│<span class="w">   </span>├──<span class="w"> </span>graph.py<span class="w">                   </span><span class="c1"># LangGraph workflow</span>
</span><span id="__span-0-23"><a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a>│<span class="w">   </span>├──<span class="w"> </span>requirements.txt
</span><span id="__span-0-24"><a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a>│<span class="w">   </span>└──<span class="w"> </span>Dockerfile
</span><span id="__span-0-25"><a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a>│
</span><span id="__span-0-26"><a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a>├──<span class="w"> </span>docker-compose.yml
</span><span id="__span-0-27"><a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a>├──<span class="w"> </span>run_services.sh
</span><span id="__span-0-28"><a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a>└──<span class="w"> </span>test_system.py
</span></code></pre></div> <h2 id="services">Services<a class="headerlink" href="#services" title="Permanent link">#</a></h2> <details> <summary>Research Service</summary> <div class="language-sh highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="w">  </span>├──<span class="w"> </span>research_service/
</span><span id="__span-1-2"><a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span>├──<span class="w"> </span>main.py<span class="w">                    </span><span class="c1"># FastAPI app</span>
</span><span id="__span-1-3"><a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span>├──<span class="w"> </span>schema.py<span class="w">                  </span><span class="c1"># Pydantic models</span>
</span><span id="__span-1-4"><a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span>├──<span class="w"> </span>graph.py<span class="w">                   </span><span class="c1"># LangGraph workflow</span>
</span></code></pre></div> <details> <summary>codes: research_service/</summary> <div class="language-python highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">schema.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span>
<span class="normal"><a href="#__codelineno-2-26">26</a></span>
<span class="normal"><a href="#__codelineno-2-27">27</a></span>
<span class="normal"><a href="#__codelineno-2-28">28</a></span>
<span class="normal"><a href="#__codelineno-2-29">29</a></span>
<span class="normal"><a href="#__codelineno-2-30">30</a></span>
<span class="normal"><a href="#__codelineno-2-31">31</a></span>
<span class="normal"><a href="#__codelineno-2-32">32</a></span>
<span class="normal"><a href="#__codelineno-2-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>  <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optionalfrom</span> <span class="n">pydantic</span> <span class="kn">import</span><span class="w"> </span><span class="nn">BaseModel</span><span class="o">,</span><span class="w"> </span><span class="nn">Field</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>  <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>  <span class="k">class</span><span class="w"> </span><span class="nc">ResearchState</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a>      <span class="n">query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>      <span class="n">research_plan</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a>      <span class="n">search_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a>      <span class="n">summary</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a>      <span class="c1"># Error handling</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a>      <span class="n">error_messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a>      <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a>      <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a>      <span class="n">failed_nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a>      <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a>          <span class="n">arbitrary_types_allowed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20"></a>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21"></a>  <span class="k">class</span><span class="w"> </span><span class="nc">ResearchRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22"></a>      <span class="n">query</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23"></a>      <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24"></a>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25"></a>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26"></a>  <span class="k">class</span><span class="w"> </span><span class="nc">ResearchResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27"></a>      <span class="n">query</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28"></a>      <span class="n">research_plan</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29"></a>      <span class="n">search_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30"></a>      <span class="n">summary</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31"></a>      <span class="n">error_messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32"></a>      <span class="n">failed_nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33"></a>      <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span>
</span></code></pre></div></td></tr></table></div> <div class="language-python highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">graph.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">  1</a></span>
<span class="normal"><a href="#__codelineno-3-2">  2</a></span>
<span class="normal"><a href="#__codelineno-3-3">  3</a></span>
<span class="normal"><a href="#__codelineno-3-4">  4</a></span>
<span class="normal"><a href="#__codelineno-3-5">  5</a></span>
<span class="normal"><a href="#__codelineno-3-6">  6</a></span>
<span class="normal"><a href="#__codelineno-3-7">  7</a></span>
<span class="normal"><a href="#__codelineno-3-8">  8</a></span>
<span class="normal"><a href="#__codelineno-3-9">  9</a></span>
<span class="normal"><a href="#__codelineno-3-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-3-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-3-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-3-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-3-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-3-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-3-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-3-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-3-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-3-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-3-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-3-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-3-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-3-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-3-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-3-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-3-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-3-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-3-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-3-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-3-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-3-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-3-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-3-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-3-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-3-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-3-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-3-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-3-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-3-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-3-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-3-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-3-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-3-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-3-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-3-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-3-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-3-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-3-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-3-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-3-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-3-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-3-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-3-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-3-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-3-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-3-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-3-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-3-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-3-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-3-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-3-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-3-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-3-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-3-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-3-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-3-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-3-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-3-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-3-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-3-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-3-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-3-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-3-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-3-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-3-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-3-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-3-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-3-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-3-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-3-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-3-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-3-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-3-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-3-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-3-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-3-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-3-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-3-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-3-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-3-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-3-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-3-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-3-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-3-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-3-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-3-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-3-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-3-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-3-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-3-100">100</a></span>
<span class="normal"><a href="#__codelineno-3-101">101</a></span>
<span class="normal"><a href="#__codelineno-3-102">102</a></span>
<span class="normal"><a href="#__codelineno-3-103">103</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>  <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>  <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a>  <span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a>  <span class="kn">from</span><span class="w"> </span><span class="nn">langchain_ollama</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOllama</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>  <span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">SystemMessage</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a>  <span class="kn">from</span><span class="w"> </span><span class="nn">agentic_app.research_service.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResearchState</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>  <span class="kn">from</span><span class="w"> </span><span class="nn">agentic_app.shared.error_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">handle_node_errors</span><span class="p">,</span> <span class="n">create_universal_router</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a>  <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a>  <span class="k">class</span><span class="w"> </span><span class="nc">ResearchNodes</span><span class="p">:</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a>      <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ChatOllama</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16"></a>          <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">llm</span> <span class="ow">or</span> <span class="n">ChatOllama</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">"gpt-oss"</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17"></a>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18"></a>      <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"validate_query"</span><span class="p">,</span> <span class="s2">"Failed to validate query"</span><span class="p">)</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19"></a>      <span class="k">def</span><span class="w"> </span><span class="nf">validate_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20"></a>          <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Validating query: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21"></a>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22"></a>          <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">query</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23"></a>              <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Query must be at least 5 characters long"</span><span class="p">)</span>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24"></a>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25"></a>          <span class="k">return</span> <span class="p">{}</span>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26"></a>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27"></a>      <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"create_plan"</span><span class="p">,</span> <span class="s2">"Failed to create research plan"</span><span class="p">)</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28"></a>      <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29"></a>          <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Creating research plan"</span><span class="p">)</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30"></a>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31"></a>          <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32"></a>              <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">"Create a brief 3-step research plan."</span><span class="p">),</span>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33"></a>              <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Create a research plan for: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34"></a>          <span class="p">]</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35"></a>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36"></a>          <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37"></a>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38"></a>          <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39"></a>              <span class="s2">"research_plan"</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40"></a>          <span class="p">}</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41"></a>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42"></a>      <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"gather_info"</span><span class="p">,</span> <span class="s2">"Failed to gather information"</span><span class="p">)</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43"></a>      <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">gather_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44"></a>          <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Gathering information"</span><span class="p">)</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45"></a>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46"></a>          <span class="c1"># Simulate research gathering</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47"></a>          <span class="n">search_results</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48"></a>              <span class="sa">f</span><span class="s2">"Finding 1 about </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49"></a>              <span class="sa">f</span><span class="s2">"Finding 2 about </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50"></a>              <span class="sa">f</span><span class="s2">"Finding 3 about </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51"></a>          <span class="p">]</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52"></a>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53"></a>          <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54"></a>              <span class="s2">"search_results"</span><span class="p">:</span> <span class="n">search_results</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55"></a>          <span class="p">}</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56"></a>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57"></a>      <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"summarize"</span><span class="p">,</span> <span class="s2">"Failed to summarize"</span><span class="p">)</span>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58"></a>      <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59"></a>          <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Summarizing findings"</span><span class="p">)</span>
</span><span id="__span-3-60"><a id="__codelineno-3-60" name="__codelineno-3-60"></a>
</span><span id="__span-3-61"><a id="__codelineno-3-61" name="__codelineno-3-61"></a>          <span class="n">findings</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">"- </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">search_results</span><span class="p">)</span>
</span><span id="__span-3-62"><a id="__codelineno-3-62" name="__codelineno-3-62"></a>
</span><span id="__span-3-63"><a id="__codelineno-3-63" name="__codelineno-3-63"></a>          <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-3-64"><a id="__codelineno-3-64" name="__codelineno-3-64"></a>              <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">"Summarize these research findings concisely."</span><span class="p">),</span>
</span><span id="__span-3-65"><a id="__codelineno-3-65" name="__codelineno-3-65"></a>              <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Plan: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">research_plan</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Findings:</span><span class="se">\n</span><span class="si">{</span><span class="n">findings</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-3-66"><a id="__codelineno-3-66" name="__codelineno-3-66"></a>          <span class="p">]</span>
</span><span id="__span-3-67"><a id="__codelineno-3-67" name="__codelineno-3-67"></a>
</span><span id="__span-3-68"><a id="__codelineno-3-68" name="__codelineno-3-68"></a>          <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span><span id="__span-3-69"><a id="__codelineno-3-69" name="__codelineno-3-69"></a>
</span><span id="__span-3-70"><a id="__codelineno-3-70" name="__codelineno-3-70"></a>          <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-3-71"><a id="__codelineno-3-71" name="__codelineno-3-71"></a>              <span class="s2">"summary"</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
</span><span id="__span-3-72"><a id="__codelineno-3-72" name="__codelineno-3-72"></a>          <span class="p">}</span>
</span><span id="__span-3-73"><a id="__codelineno-3-73" name="__codelineno-3-73"></a>
</span><span id="__span-3-74"><a id="__codelineno-3-74" name="__codelineno-3-74"></a>
</span><span id="__span-3-75"><a id="__codelineno-3-75" name="__codelineno-3-75"></a>  <span class="k">def</span><span class="w"> </span><span class="nf">create_research_graph</span><span class="p">():</span>
</span><span id="__span-3-76"><a id="__codelineno-3-76" name="__codelineno-3-76"></a>      <span class="n">nodes</span> <span class="o">=</span> <span class="n">ResearchNodes</span><span class="p">()</span>
</span><span id="__span-3-77"><a id="__codelineno-3-77" name="__codelineno-3-77"></a>      <span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">ResearchState</span><span class="p">)</span>
</span><span id="__span-3-78"><a id="__codelineno-3-78" name="__codelineno-3-78"></a>
</span><span id="__span-3-79"><a id="__codelineno-3-79" name="__codelineno-3-79"></a>      <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"validate_query"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">validate_query</span><span class="p">)</span>
</span><span id="__span-3-80"><a id="__codelineno-3-80" name="__codelineno-3-80"></a>      <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"create_plan"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">create_plan</span><span class="p">)</span>
</span><span id="__span-3-81"><a id="__codelineno-3-81" name="__codelineno-3-81"></a>      <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"gather_info"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">gather_info</span><span class="p">)</span>
</span><span id="__span-3-82"><a id="__codelineno-3-82" name="__codelineno-3-82"></a>      <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"summarize"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">summarize</span><span class="p">)</span>
</span><span id="__span-3-83"><a id="__codelineno-3-83" name="__codelineno-3-83"></a>
</span><span id="__span-3-84"><a id="__codelineno-3-84" name="__codelineno-3-84"></a>      <span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">"validate_query"</span><span class="p">)</span>
</span><span id="__span-3-85"><a id="__codelineno-3-85" name="__codelineno-3-85"></a>
</span><span id="__span-3-86"><a id="__codelineno-3-86" name="__codelineno-3-86"></a>      <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-3-87"><a id="__codelineno-3-87" name="__codelineno-3-87"></a>          <span class="s2">"validate_query"</span><span class="p">,</span>
</span><span id="__span-3-88"><a id="__codelineno-3-88" name="__codelineno-3-88"></a>          <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="s2">"create_plan"</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="s2">"validate_query"</span><span class="p">)</span>
</span><span id="__span-3-89"><a id="__codelineno-3-89" name="__codelineno-3-89"></a>      <span class="p">)</span>
</span><span id="__span-3-90"><a id="__codelineno-3-90" name="__codelineno-3-90"></a>      <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-3-91"><a id="__codelineno-3-91" name="__codelineno-3-91"></a>          <span class="s2">"create_plan"</span><span class="p">,</span>
</span><span id="__span-3-92"><a id="__codelineno-3-92" name="__codelineno-3-92"></a>          <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="s2">"gather_info"</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="s2">"create_plan"</span><span class="p">)</span>
</span><span id="__span-3-93"><a id="__codelineno-3-93" name="__codelineno-3-93"></a>      <span class="p">)</span>
</span><span id="__span-3-94"><a id="__codelineno-3-94" name="__codelineno-3-94"></a>      <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-3-95"><a id="__codelineno-3-95" name="__codelineno-3-95"></a>          <span class="s2">"gather_info"</span><span class="p">,</span>
</span><span id="__span-3-96"><a id="__codelineno-3-96" name="__codelineno-3-96"></a>          <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="s2">"summarize"</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="s2">"gather_info"</span><span class="p">)</span>
</span><span id="__span-3-97"><a id="__codelineno-3-97" name="__codelineno-3-97"></a>      <span class="p">)</span>
</span><span id="__span-3-98"><a id="__codelineno-3-98" name="__codelineno-3-98"></a>      <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-3-99"><a id="__codelineno-3-99" name="__codelineno-3-99"></a>          <span class="s2">"summarize"</span><span class="p">,</span>
</span><span id="__span-3-100"><a id="__codelineno-3-100" name="__codelineno-3-100"></a>          <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="n">END</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="s2">"summarize"</span><span class="p">)</span>
</span><span id="__span-3-101"><a id="__codelineno-3-101" name="__codelineno-3-101"></a>      <span class="p">)</span>
</span><span id="__span-3-102"><a id="__codelineno-3-102" name="__codelineno-3-102"></a>
</span><span id="__span-3-103"><a id="__codelineno-3-103" name="__codelineno-3-103"></a>      <span class="k">return</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div> <div class="language-python highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">main.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span>
<span class="normal"><a href="#__codelineno-4-33">33</a></span>
<span class="normal"><a href="#__codelineno-4-34">34</a></span>
<span class="normal"><a href="#__codelineno-4-35">35</a></span>
<span class="normal"><a href="#__codelineno-4-36">36</a></span>
<span class="normal"><a href="#__codelineno-4-37">37</a></span>
<span class="normal"><a href="#__codelineno-4-38">38</a></span>
<span class="normal"><a href="#__codelineno-4-39">39</a></span>
<span class="normal"><a href="#__codelineno-4-40">40</a></span>
<span class="normal"><a href="#__codelineno-4-41">41</a></span>
<span class="normal"><a href="#__codelineno-4-42">42</a></span>
<span class="normal"><a href="#__codelineno-4-43">43</a></span>
<span class="normal"><a href="#__codelineno-4-44">44</a></span>
<span class="normal"><a href="#__codelineno-4-45">45</a></span>
<span class="normal"><a href="#__codelineno-4-46">46</a></span>
<span class="normal"><a href="#__codelineno-4-47">47</a></span>
<span class="normal"><a href="#__codelineno-4-48">48</a></span>
<span class="normal"><a href="#__codelineno-4-49">49</a></span>
<span class="normal"><a href="#__codelineno-4-50">50</a></span>
<span class="normal"><a href="#__codelineno-4-51">51</a></span>
<span class="normal"><a href="#__codelineno-4-52">52</a></span>
<span class="normal"><a href="#__codelineno-4-53">53</a></span>
<span class="normal"><a href="#__codelineno-4-54">54</a></span>
<span class="normal"><a href="#__codelineno-4-55">55</a></span>
<span class="normal"><a href="#__codelineno-4-56">56</a></span>
<span class="normal"><a href="#__codelineno-4-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">agentic_app.analysis_service.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_analysis_graph</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">agentic_app.analysis_service.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnalysisState</span><span class="p">,</span> <span class="n">AnalysisRequest</span><span class="p">,</span> <span class="n">AnalysisResponse</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a>    <span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Analysis Service"</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">"1.0.0"</span><span class="p">)</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a>        <span class="n">CORSMiddleware</span><span class="p">,</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a>        <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a>        <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a>        <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a>        <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a>    <span class="p">)</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a>    <span class="n">analysis_graph</span> <span class="o">=</span> <span class="n">create_analysis_graph</span><span class="p">()</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a>    <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/analyze"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">AnalysisResponse</span><span class="p">)</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">analyze_research</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">AnalysisRequest</span><span class="p">):</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">        </span><span class="sd">"""Analyze research summary and generate insights"""</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Received analysis request"</span><span class="p">)</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29"></a>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30"></a>            <span class="n">initial_state</span> <span class="o">=</span> <span class="n">AnalysisState</span><span class="p">(</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31"></a>                <span class="n">research_summary</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">research_summary</span><span class="p">,</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32"></a>                <span class="n">max_retries</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">max_retries</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33"></a>            <span class="p">)</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34"></a>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35"></a>            <span class="n">final_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">analysis_graph</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">initial_state</span><span class="p">)</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36"></a>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37"></a>            <span class="k">return</span> <span class="n">AnalysisResponse</span><span class="p">(</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38"></a>                <span class="n">insights</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"insights"</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39"></a>                <span class="n">recommendations</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"recommendations"</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40"></a>                <span class="n">final_analysis</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"final_analysis"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41"></a>                <span class="n">error_messages</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"error_messages"</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42"></a>                <span class="n">failed_nodes</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"failed_nodes"</span><span class="p">,</span> <span class="p">{}),</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43"></a>                <span class="n">success</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"error_messages"</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44"></a>            <span class="p">)</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45"></a>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Analysis failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49"></a>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50"></a>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51"></a>    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/health"</span><span class="p">)</span>
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">():</span>
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">"status"</span><span class="p">:</span> <span class="s2">"healthy"</span><span class="p">,</span> <span class="s2">"service"</span><span class="p">:</span> <span class="s2">"analysis"</span><span class="p">}</span>
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54"></a>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55"></a>    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
</span><span id="__span-4-56"><a id="__codelineno-4-56" name="__codelineno-4-56"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
</span><span id="__span-4-57"><a id="__codelineno-4-57" name="__codelineno-4-57"></a>        <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">"0.0.0.0"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8082</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div> </details> </details> <details> <summary>Analysis Service</summary> <div class="language-sh highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="w"> </span>├──<span class="w"> </span>analysis_service/
</span><span id="__span-5-2"><a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w"> </span>├──<span class="w"> </span>main.py<span class="w">                    </span><span class="c1"># FastAPI app</span>
</span><span id="__span-5-3"><a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w"> </span>├──<span class="w"> </span>schema.py<span class="w">                  </span><span class="c1"># Pydantic models</span>
</span><span id="__span-5-4"><a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w"> </span>├──<span class="w"> </span>graph.py<span class="w">    </span>
</span></code></pre></div> <details> <summary>codes: analysis_service/</summary> <div class="language-python highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">schema.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>  <span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">ConfigDict</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a>  <span class="k">class</span><span class="w"> </span><span class="nc">AnalysisState</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a>      <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a>      <span class="n">research_summary</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a>      <span class="n">insights</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a>      <span class="n">recommendations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a>      <span class="n">final_analysis</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a>      <span class="c1"># Error handling</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a>      <span class="n">error_messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a>      <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a>      <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a>      <span class="n">failed_nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a>  <span class="k">class</span><span class="w"> </span><span class="nc">AnalysisRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a>      <span class="n">research_summary</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a>      <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a>  <span class="k">class</span><span class="w"> </span><span class="nc">AnalysisResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a>      <span class="n">insights</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a>      <span class="n">recommendations</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a>      <span class="n">final_analysis</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a>      <span class="n">error_messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a>      <span class="n">failed_nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a>      <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span>
</span></code></pre></div></td></tr></table></div> <div class="language-python highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">graph.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span>
<span class="normal"><a href="#__codelineno-7-36">36</a></span>
<span class="normal"><a href="#__codelineno-7-37">37</a></span>
<span class="normal"><a href="#__codelineno-7-38">38</a></span>
<span class="normal"><a href="#__codelineno-7-39">39</a></span>
<span class="normal"><a href="#__codelineno-7-40">40</a></span>
<span class="normal"><a href="#__codelineno-7-41">41</a></span>
<span class="normal"><a href="#__codelineno-7-42">42</a></span>
<span class="normal"><a href="#__codelineno-7-43">43</a></span>
<span class="normal"><a href="#__codelineno-7-44">44</a></span>
<span class="normal"><a href="#__codelineno-7-45">45</a></span>
<span class="normal"><a href="#__codelineno-7-46">46</a></span>
<span class="normal"><a href="#__codelineno-7-47">47</a></span>
<span class="normal"><a href="#__codelineno-7-48">48</a></span>
<span class="normal"><a href="#__codelineno-7-49">49</a></span>
<span class="normal"><a href="#__codelineno-7-50">50</a></span>
<span class="normal"><a href="#__codelineno-7-51">51</a></span>
<span class="normal"><a href="#__codelineno-7-52">52</a></span>
<span class="normal"><a href="#__codelineno-7-53">53</a></span>
<span class="normal"><a href="#__codelineno-7-54">54</a></span>
<span class="normal"><a href="#__codelineno-7-55">55</a></span>
<span class="normal"><a href="#__codelineno-7-56">56</a></span>
<span class="normal"><a href="#__codelineno-7-57">57</a></span>
<span class="normal"><a href="#__codelineno-7-58">58</a></span>
<span class="normal"><a href="#__codelineno-7-59">59</a></span>
<span class="normal"><a href="#__codelineno-7-60">60</a></span>
<span class="normal"><a href="#__codelineno-7-61">61</a></span>
<span class="normal"><a href="#__codelineno-7-62">62</a></span>
<span class="normal"><a href="#__codelineno-7-63">63</a></span>
<span class="normal"><a href="#__codelineno-7-64">64</a></span>
<span class="normal"><a href="#__codelineno-7-65">65</a></span>
<span class="normal"><a href="#__codelineno-7-66">66</a></span>
<span class="normal"><a href="#__codelineno-7-67">67</a></span>
<span class="normal"><a href="#__codelineno-7-68">68</a></span>
<span class="normal"><a href="#__codelineno-7-69">69</a></span>
<span class="normal"><a href="#__codelineno-7-70">70</a></span>
<span class="normal"><a href="#__codelineno-7-71">71</a></span>
<span class="normal"><a href="#__codelineno-7-72">72</a></span>
<span class="normal"><a href="#__codelineno-7-73">73</a></span>
<span class="normal"><a href="#__codelineno-7-74">74</a></span>
<span class="normal"><a href="#__codelineno-7-75">75</a></span>
<span class="normal"><a href="#__codelineno-7-76">76</a></span>
<span class="normal"><a href="#__codelineno-7-77">77</a></span>
<span class="normal"><a href="#__codelineno-7-78">78</a></span>
<span class="normal"><a href="#__codelineno-7-79">79</a></span>
<span class="normal"><a href="#__codelineno-7-80">80</a></span>
<span class="normal"><a href="#__codelineno-7-81">81</a></span>
<span class="normal"><a href="#__codelineno-7-82">82</a></span>
<span class="normal"><a href="#__codelineno-7-83">83</a></span>
<span class="normal"><a href="#__codelineno-7-84">84</a></span>
<span class="normal"><a href="#__codelineno-7-85">85</a></span>
<span class="normal"><a href="#__codelineno-7-86">86</a></span>
<span class="normal"><a href="#__codelineno-7-87">87</a></span>
<span class="normal"><a href="#__codelineno-7-88">88</a></span>
<span class="normal"><a href="#__codelineno-7-89">89</a></span>
<span class="normal"><a href="#__codelineno-7-90">90</a></span>
<span class="normal"><a href="#__codelineno-7-91">91</a></span>
<span class="normal"><a href="#__codelineno-7-92">92</a></span>
<span class="normal"><a href="#__codelineno-7-93">93</a></span>
<span class="normal"><a href="#__codelineno-7-94">94</a></span>
<span class="normal"><a href="#__codelineno-7-95">95</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">langchain_ollama</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOllama</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">SystemMessage</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">agentic_app.analysis_service.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnalysisState</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">agentic_app.shared.error_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">handle_node_errors</span><span class="p">,</span> <span class="n">create_universal_router</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12"></a>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13"></a>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">AnalysisNodes</span><span class="p">:</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15"></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ChatOllama</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">llm</span> <span class="ow">or</span> <span class="n">ChatOllama</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">"gpt-oss"</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17"></a>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18"></a>        <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"extract_insights"</span><span class="p">,</span> <span class="s2">"Failed to extract insights"</span><span class="p">)</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">extract_insights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AnalysisState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Extracting insights"</span><span class="p">)</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21"></a>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22"></a>            <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23"></a>                <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">"Extract 3 key insights from this research."</span><span class="p">),</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24"></a>                <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">research_summary</span><span class="p">)</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25"></a>            <span class="p">]</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26"></a>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28"></a>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29"></a>            <span class="c1"># Parse insights (simplified)</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30"></a>            <span class="n">insights</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()][:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31"></a>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33"></a>                <span class="s2">"insights"</span><span class="p">:</span> <span class="n">insights</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34"></a>            <span class="p">}</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35"></a>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36"></a>        <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"generate_recommendations"</span><span class="p">,</span> <span class="s2">"Failed to generate recommendations"</span><span class="p">)</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_recommendations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AnalysisState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Generating recommendations"</span><span class="p">)</span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39"></a>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40"></a>            <span class="n">insights_text</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">"- </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">insights</span><span class="p">)</span>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41"></a>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42"></a>            <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43"></a>                <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">"Generate 3 actionable recommendations based on these insights."</span><span class="p">),</span>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44"></a>                <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">insights_text</span><span class="p">)</span>
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45"></a>            <span class="p">]</span>
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46"></a>
</span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48"></a>
</span><span id="__span-7-49"><a id="__codelineno-7-49" name="__codelineno-7-49"></a>            <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()][:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="__span-7-50"><a id="__codelineno-7-50" name="__codelineno-7-50"></a>
</span><span id="__span-7-51"><a id="__codelineno-7-51" name="__codelineno-7-51"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-7-52"><a id="__codelineno-7-52" name="__codelineno-7-52"></a>                <span class="s2">"recommendations"</span><span class="p">:</span> <span class="n">recommendations</span>
</span><span id="__span-7-53"><a id="__codelineno-7-53" name="__codelineno-7-53"></a>            <span class="p">}</span>
</span><span id="__span-7-54"><a id="__codelineno-7-54" name="__codelineno-7-54"></a>
</span><span id="__span-7-55"><a id="__codelineno-7-55" name="__codelineno-7-55"></a>        <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"create_analysis"</span><span class="p">,</span> <span class="s2">"Failed to create final analysis"</span><span class="p">)</span>
</span><span id="__span-7-56"><a id="__codelineno-7-56" name="__codelineno-7-56"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">AnalysisState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-7-57"><a id="__codelineno-7-57" name="__codelineno-7-57"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Creating final analysis"</span><span class="p">)</span>
</span><span id="__span-7-58"><a id="__codelineno-7-58" name="__codelineno-7-58"></a>
</span><span id="__span-7-59"><a id="__codelineno-7-59" name="__codelineno-7-59"></a>            <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-7-60"><a id="__codelineno-7-60" name="__codelineno-7-60"></a>                <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">"Create a concise final analysis report."</span><span class="p">),</span>
</span><span id="__span-7-61"><a id="__codelineno-7-61" name="__codelineno-7-61"></a>                <span class="n">HumanMessage</span><span class="p">(</span>
</span><span id="__span-7-62"><a id="__codelineno-7-62" name="__codelineno-7-62"></a>                    <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Summary: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">research_summary</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Insights: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">insights</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Recommendations: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">recommendations</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-7-63"><a id="__codelineno-7-63" name="__codelineno-7-63"></a>            <span class="p">]</span>
</span><span id="__span-7-64"><a id="__codelineno-7-64" name="__codelineno-7-64"></a>
</span><span id="__span-7-65"><a id="__codelineno-7-65" name="__codelineno-7-65"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span><span id="__span-7-66"><a id="__codelineno-7-66" name="__codelineno-7-66"></a>
</span><span id="__span-7-67"><a id="__codelineno-7-67" name="__codelineno-7-67"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-7-68"><a id="__codelineno-7-68" name="__codelineno-7-68"></a>                <span class="s2">"final_analysis"</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
</span><span id="__span-7-69"><a id="__codelineno-7-69" name="__codelineno-7-69"></a>            <span class="p">}</span>
</span><span id="__span-7-70"><a id="__codelineno-7-70" name="__codelineno-7-70"></a>
</span><span id="__span-7-71"><a id="__codelineno-7-71" name="__codelineno-7-71"></a>
</span><span id="__span-7-72"><a id="__codelineno-7-72" name="__codelineno-7-72"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_analysis_graph</span><span class="p">():</span>
</span><span id="__span-7-73"><a id="__codelineno-7-73" name="__codelineno-7-73"></a>        <span class="n">nodes</span> <span class="o">=</span> <span class="n">AnalysisNodes</span><span class="p">()</span>
</span><span id="__span-7-74"><a id="__codelineno-7-74" name="__codelineno-7-74"></a>        <span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">AnalysisState</span><span class="p">)</span>
</span><span id="__span-7-75"><a id="__codelineno-7-75" name="__codelineno-7-75"></a>
</span><span id="__span-7-76"><a id="__codelineno-7-76" name="__codelineno-7-76"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"extract_insights"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">extract_insights</span><span class="p">)</span>
</span><span id="__span-7-77"><a id="__codelineno-7-77" name="__codelineno-7-77"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"generate_recommendations"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">generate_recommendations</span><span class="p">)</span>
</span><span id="__span-7-78"><a id="__codelineno-7-78" name="__codelineno-7-78"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"create_analysis"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">create_analysis</span><span class="p">)</span>
</span><span id="__span-7-79"><a id="__codelineno-7-79" name="__codelineno-7-79"></a>
</span><span id="__span-7-80"><a id="__codelineno-7-80" name="__codelineno-7-80"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">"extract_insights"</span><span class="p">)</span>
</span><span id="__span-7-81"><a id="__codelineno-7-81" name="__codelineno-7-81"></a>
</span><span id="__span-7-82"><a id="__codelineno-7-82" name="__codelineno-7-82"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-7-83"><a id="__codelineno-7-83" name="__codelineno-7-83"></a>            <span class="s2">"extract_insights"</span><span class="p">,</span>
</span><span id="__span-7-84"><a id="__codelineno-7-84" name="__codelineno-7-84"></a>            <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="s2">"generate_recommendations"</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="s2">"extract_insights"</span><span class="p">)</span>
</span><span id="__span-7-85"><a id="__codelineno-7-85" name="__codelineno-7-85"></a>        <span class="p">)</span>
</span><span id="__span-7-86"><a id="__codelineno-7-86" name="__codelineno-7-86"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-7-87"><a id="__codelineno-7-87" name="__codelineno-7-87"></a>            <span class="s2">"generate_recommendations"</span><span class="p">,</span>
</span><span id="__span-7-88"><a id="__codelineno-7-88" name="__codelineno-7-88"></a>            <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="s2">"create_analysis"</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="s2">"generate_recommendations"</span><span class="p">)</span>
</span><span id="__span-7-89"><a id="__codelineno-7-89" name="__codelineno-7-89"></a>        <span class="p">)</span>
</span><span id="__span-7-90"><a id="__codelineno-7-90" name="__codelineno-7-90"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-7-91"><a id="__codelineno-7-91" name="__codelineno-7-91"></a>            <span class="s2">"create_analysis"</span><span class="p">,</span>
</span><span id="__span-7-92"><a id="__codelineno-7-92" name="__codelineno-7-92"></a>            <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="n">END</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="s2">"create_analysis"</span><span class="p">)</span>
</span><span id="__span-7-93"><a id="__codelineno-7-93" name="__codelineno-7-93"></a>        <span class="p">)</span>
</span><span id="__span-7-94"><a id="__codelineno-7-94" name="__codelineno-7-94"></a>
</span><span id="__span-7-95"><a id="__codelineno-7-95" name="__codelineno-7-95"></a>        <span class="k">return</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div> <div class="language-python highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">main.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span>
<span class="normal"><a href="#__codelineno-8-36">36</a></span>
<span class="normal"><a href="#__codelineno-8-37">37</a></span>
<span class="normal"><a href="#__codelineno-8-38">38</a></span>
<span class="normal"><a href="#__codelineno-8-39">39</a></span>
<span class="normal"><a href="#__codelineno-8-40">40</a></span>
<span class="normal"><a href="#__codelineno-8-41">41</a></span>
<span class="normal"><a href="#__codelineno-8-42">42</a></span>
<span class="normal"><a href="#__codelineno-8-43">43</a></span>
<span class="normal"><a href="#__codelineno-8-44">44</a></span>
<span class="normal"><a href="#__codelineno-8-45">45</a></span>
<span class="normal"><a href="#__codelineno-8-46">46</a></span>
<span class="normal"><a href="#__codelineno-8-47">47</a></span>
<span class="normal"><a href="#__codelineno-8-48">48</a></span>
<span class="normal"><a href="#__codelineno-8-49">49</a></span>
<span class="normal"><a href="#__codelineno-8-50">50</a></span>
<span class="normal"><a href="#__codelineno-8-51">51</a></span>
<span class="normal"><a href="#__codelineno-8-52">52</a></span>
<span class="normal"><a href="#__codelineno-8-53">53</a></span>
<span class="normal"><a href="#__codelineno-8-54">54</a></span>
<span class="normal"><a href="#__codelineno-8-55">55</a></span>
<span class="normal"><a href="#__codelineno-8-56">56</a></span>
<span class="normal"><a href="#__codelineno-8-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">agentic_app.analysis_service.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_analysis_graph</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">agentic_app.analysis_service.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnalysisState</span><span class="p">,</span> <span class="n">AnalysisRequest</span><span class="p">,</span> <span class="n">AnalysisResponse</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11"></a>    <span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Analysis Service"</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">"1.0.0"</span><span class="p">)</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12"></a>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14"></a>        <span class="n">CORSMiddleware</span><span class="p">,</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15"></a>        <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16"></a>        <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17"></a>        <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18"></a>        <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19"></a>    <span class="p">)</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20"></a>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21"></a>    <span class="n">analysis_graph</span> <span class="o">=</span> <span class="n">create_analysis_graph</span><span class="p">()</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22"></a>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23"></a>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24"></a>    <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/analyze"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">AnalysisResponse</span><span class="p">)</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">analyze_research</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">AnalysisRequest</span><span class="p">):</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="w">        </span><span class="sd">"""Analyze research summary and generate insights"""</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Received analysis request"</span><span class="p">)</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29"></a>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30"></a>            <span class="n">initial_state</span> <span class="o">=</span> <span class="n">AnalysisState</span><span class="p">(</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31"></a>                <span class="n">research_summary</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">research_summary</span><span class="p">,</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32"></a>                <span class="n">max_retries</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">max_retries</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33"></a>            <span class="p">)</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34"></a>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35"></a>            <span class="n">final_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">analysis_graph</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">initial_state</span><span class="p">)</span>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36"></a>
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37"></a>            <span class="k">return</span> <span class="n">AnalysisResponse</span><span class="p">(</span>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38"></a>                <span class="n">insights</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"insights"</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39"></a>                <span class="n">recommendations</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"recommendations"</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40"></a>                <span class="n">final_analysis</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"final_analysis"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41"></a>                <span class="n">error_messages</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"error_messages"</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42"></a>                <span class="n">failed_nodes</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"failed_nodes"</span><span class="p">,</span> <span class="p">{}),</span>
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43"></a>                <span class="n">success</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"error_messages"</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44"></a>            <span class="p">)</span>
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45"></a>
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Analysis failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49"></a>
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50"></a>
</span><span id="__span-8-51"><a id="__codelineno-8-51" name="__codelineno-8-51"></a>    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/health"</span><span class="p">)</span>
</span><span id="__span-8-52"><a id="__codelineno-8-52" name="__codelineno-8-52"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">():</span>
</span><span id="__span-8-53"><a id="__codelineno-8-53" name="__codelineno-8-53"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">"status"</span><span class="p">:</span> <span class="s2">"healthy"</span><span class="p">,</span> <span class="s2">"service"</span><span class="p">:</span> <span class="s2">"analysis"</span><span class="p">}</span>
</span><span id="__span-8-54"><a id="__codelineno-8-54" name="__codelineno-8-54"></a>
</span><span id="__span-8-55"><a id="__codelineno-8-55" name="__codelineno-8-55"></a>    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
</span><span id="__span-8-56"><a id="__codelineno-8-56" name="__codelineno-8-56"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
</span><span id="__span-8-57"><a id="__codelineno-8-57" name="__codelineno-8-57"></a>        <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">"0.0.0.0"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8082</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div> </details> </details> <details> <summary>Supervisor Service</summary> <div class="language-sh highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="w"> </span>├──<span class="w"> </span>supervisor_service/
</span><span id="__span-9-2"><a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w"> </span>├──<span class="w"> </span>main.py<span class="w">                    </span><span class="c1"># FastAPI app</span>
</span><span id="__span-9-3"><a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w"> </span>├──<span class="w"> </span>schema.py<span class="w">                  </span><span class="c1"># Pydantic models</span>
</span><span id="__span-9-4"><a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w"> </span>├──<span class="w"> </span>graph.py<span class="w">                   </span><span class="c1"># LangGraph workflow</span>
</span></code></pre></div> <details> <summary>codes: analysis_service/</summary> <div class="language-python highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">schema.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span>
<span class="normal"><a href="#__codelineno-10-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a>  <span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a>  <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a>  <span class="k">class</span><span class="w"> </span><span class="nc">SupervisorState</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a>      <span class="n">original_query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a>      <span class="n">research_result</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a>      <span class="n">analysis_result</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a>      <span class="n">final_report</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a>      <span class="c1"># Error handling</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a>      <span class="n">error_messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13"></a>      <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14"></a>      <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15"></a>      <span class="n">failed_nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16"></a>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17"></a>      <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18"></a>          <span class="n">arbitrary_types_allowed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19"></a>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20"></a>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21"></a>  <span class="k">class</span><span class="w"> </span><span class="nc">SupervisorRequest</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22"></a>      <span class="n">query</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23"></a>      <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24"></a>      <span class="n">research_service_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"http://localhost:8081"</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25"></a>      <span class="n">analysis_service_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"http://localhost:8082"</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26"></a>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27"></a>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28"></a>  <span class="k">class</span><span class="w"> </span><span class="nc">SupervisorResponse</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29"></a>      <span class="n">query</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30"></a>      <span class="n">research_summary</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31"></a>      <span class="n">analysis_report</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32"></a>      <span class="n">final_report</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33"></a>      <span class="n">error_messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34"></a>      <span class="n">failed_nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35"></a>      <span class="n">success</span><span class="p">:</span> <span class="nb">bool</span>
</span></code></pre></div></td></tr></table></div> <div class="language-python highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">graph.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">  1</a></span>
<span class="normal"><a href="#__codelineno-11-2">  2</a></span>
<span class="normal"><a href="#__codelineno-11-3">  3</a></span>
<span class="normal"><a href="#__codelineno-11-4">  4</a></span>
<span class="normal"><a href="#__codelineno-11-5">  5</a></span>
<span class="normal"><a href="#__codelineno-11-6">  6</a></span>
<span class="normal"><a href="#__codelineno-11-7">  7</a></span>
<span class="normal"><a href="#__codelineno-11-8">  8</a></span>
<span class="normal"><a href="#__codelineno-11-9">  9</a></span>
<span class="normal"><a href="#__codelineno-11-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-11-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-11-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-11-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-11-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-11-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-11-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-11-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-11-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-11-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-11-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-11-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-11-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-11-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-11-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-11-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-11-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-11-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-11-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-11-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-11-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-11-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-11-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-11-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-11-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-11-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-11-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-11-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-11-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-11-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-11-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-11-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-11-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-11-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-11-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-11-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-11-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-11-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-11-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-11-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-11-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-11-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-11-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-11-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-11-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-11-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-11-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-11-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-11-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-11-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-11-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-11-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-11-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-11-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-11-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-11-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-11-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-11-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-11-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-11-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-11-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-11-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-11-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-11-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-11-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-11-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-11-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-11-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-11-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-11-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-11-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-11-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-11-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-11-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-11-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-11-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-11-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-11-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-11-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-11-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-11-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-11-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-11-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-11-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-11-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-11-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-11-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-11-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-11-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-11-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-11-100">100</a></span>
<span class="normal"><a href="#__codelineno-11-101">101</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">httpx</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">langchain_ollama</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOllama</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">SystemMessage</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">agentic_app.shared.error_handler</span><span class="w"> </span><span class="kn">import</span> <span class="n">handle_node_errors</span><span class="p">,</span> <span class="n">create_universal_router</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">agentic_app.supervisor_service.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">SupervisorState</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">SupervisorNodes</span><span class="p">:</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a>        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">research_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">analysis_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ChatOllama</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">research_url</span> <span class="o">=</span> <span class="n">research_url</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">analysis_url</span> <span class="o">=</span> <span class="n">analysis_url</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">llm</span> <span class="ow">or</span> <span class="n">ChatOllama</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">"gpt-oss"</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a>        <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"call_research"</span><span class="p">,</span> <span class="s2">"Failed to call research service"</span><span class="p">)</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_research</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SupervisorState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Calling research service at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">research_url</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24"></a>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25"></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">300.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26"></a>                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27"></a>                    <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">research_url</span><span class="si">}</span><span class="s2">/research"</span><span class="p">,</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28"></a>                    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">"query"</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">original_query</span><span class="p">,</span> <span class="s2">"max_retries"</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">max_retries</span><span class="p">}</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29"></a>                <span class="p">)</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30"></a>                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31"></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32"></a>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"success"</span><span class="p">):</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34"></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Research service failed: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'error_messages'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35"></a>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37"></a>                <span class="s2">"research_result"</span><span class="p">:</span> <span class="n">result</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38"></a>            <span class="p">}</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39"></a>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40"></a>        <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"call_analysis"</span><span class="p">,</span> <span class="s2">"Failed to call analysis service"</span><span class="p">)</span>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SupervisorState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Calling analysis service at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_url</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43"></a>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44"></a>            <span class="n">research_summary</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">research_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"summary"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45"></a>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46"></a>            <span class="k">async</span> <span class="k">with</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">300.0</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47"></a>                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48"></a>                    <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_url</span><span class="si">}</span><span class="s2">/analyze"</span><span class="p">,</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49"></a>                    <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">"research_summary"</span><span class="p">:</span> <span class="n">research_summary</span><span class="p">,</span> <span class="s2">"max_retries"</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">max_retries</span><span class="p">}</span>
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50"></a>                <span class="p">)</span>
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51"></a>                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52"></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53"></a>
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"success"</span><span class="p">):</span>
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55"></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Analysis service failed: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'error_messages'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56"></a>
</span><span id="__span-11-57"><a id="__codelineno-11-57" name="__codelineno-11-57"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-11-58"><a id="__codelineno-11-58" name="__codelineno-11-58"></a>                <span class="s2">"analysis_result"</span><span class="p">:</span> <span class="n">result</span>
</span><span id="__span-11-59"><a id="__codelineno-11-59" name="__codelineno-11-59"></a>            <span class="p">}</span>
</span><span id="__span-11-60"><a id="__codelineno-11-60" name="__codelineno-11-60"></a>
</span><span id="__span-11-61"><a id="__codelineno-11-61" name="__codelineno-11-61"></a>        <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"generate_final_report"</span><span class="p">,</span> <span class="s2">"Failed to generate final report"</span><span class="p">)</span>
</span><span id="__span-11-62"><a id="__codelineno-11-62" name="__codelineno-11-62"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_final_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SupervisorState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-11-63"><a id="__codelineno-11-63" name="__codelineno-11-63"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Generating final report"</span><span class="p">)</span>
</span><span id="__span-11-64"><a id="__codelineno-11-64" name="__codelineno-11-64"></a>
</span><span id="__span-11-65"><a id="__codelineno-11-65" name="__codelineno-11-65"></a>            <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-11-66"><a id="__codelineno-11-66" name="__codelineno-11-66"></a>                <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">"Create a comprehensive final report combining research and analysis."</span><span class="p">),</span>
</span><span id="__span-11-67"><a id="__codelineno-11-67" name="__codelineno-11-67"></a>                <span class="n">HumanMessage</span><span class="p">(</span>
</span><span id="__span-11-68"><a id="__codelineno-11-68" name="__codelineno-11-68"></a>                    <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Query: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">original_query</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Research: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">research_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'summary'</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Analysis: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">analysis_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'final_analysis'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-11-69"><a id="__codelineno-11-69" name="__codelineno-11-69"></a>            <span class="p">]</span>
</span><span id="__span-11-70"><a id="__codelineno-11-70" name="__codelineno-11-70"></a>
</span><span id="__span-11-71"><a id="__codelineno-11-71" name="__codelineno-11-71"></a>            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span><span id="__span-11-72"><a id="__codelineno-11-72" name="__codelineno-11-72"></a>
</span><span id="__span-11-73"><a id="__codelineno-11-73" name="__codelineno-11-73"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-11-74"><a id="__codelineno-11-74" name="__codelineno-11-74"></a>                <span class="s2">"final_report"</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
</span><span id="__span-11-75"><a id="__codelineno-11-75" name="__codelineno-11-75"></a>            <span class="p">}</span>
</span><span id="__span-11-76"><a id="__codelineno-11-76" name="__codelineno-11-76"></a>
</span><span id="__span-11-77"><a id="__codelineno-11-77" name="__codelineno-11-77"></a>
</span><span id="__span-11-78"><a id="__codelineno-11-78" name="__codelineno-11-78"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_supervisor_graph</span><span class="p">(</span><span class="n">research_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">analysis_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="__span-11-79"><a id="__codelineno-11-79" name="__codelineno-11-79"></a>        <span class="n">nodes</span> <span class="o">=</span> <span class="n">SupervisorNodes</span><span class="p">(</span><span class="n">research_url</span><span class="p">,</span> <span class="n">analysis_url</span><span class="p">)</span>
</span><span id="__span-11-80"><a id="__codelineno-11-80" name="__codelineno-11-80"></a>        <span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">SupervisorState</span><span class="p">)</span>
</span><span id="__span-11-81"><a id="__codelineno-11-81" name="__codelineno-11-81"></a>
</span><span id="__span-11-82"><a id="__codelineno-11-82" name="__codelineno-11-82"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"call_research"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">call_research</span><span class="p">)</span>
</span><span id="__span-11-83"><a id="__codelineno-11-83" name="__codelineno-11-83"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"call_analysis"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">call_analysis</span><span class="p">)</span>
</span><span id="__span-11-84"><a id="__codelineno-11-84" name="__codelineno-11-84"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"generate_final_report"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">generate_final_report</span><span class="p">)</span>
</span><span id="__span-11-85"><a id="__codelineno-11-85" name="__codelineno-11-85"></a>
</span><span id="__span-11-86"><a id="__codelineno-11-86" name="__codelineno-11-86"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">"call_research"</span><span class="p">)</span>
</span><span id="__span-11-87"><a id="__codelineno-11-87" name="__codelineno-11-87"></a>
</span><span id="__span-11-88"><a id="__codelineno-11-88" name="__codelineno-11-88"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-11-89"><a id="__codelineno-11-89" name="__codelineno-11-89"></a>            <span class="s2">"call_research"</span><span class="p">,</span>
</span><span id="__span-11-90"><a id="__codelineno-11-90" name="__codelineno-11-90"></a>            <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="s2">"call_analysis"</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="s2">"call_research"</span><span class="p">)</span>
</span><span id="__span-11-91"><a id="__codelineno-11-91" name="__codelineno-11-91"></a>        <span class="p">)</span>
</span><span id="__span-11-92"><a id="__codelineno-11-92" name="__codelineno-11-92"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-11-93"><a id="__codelineno-11-93" name="__codelineno-11-93"></a>            <span class="s2">"call_analysis"</span><span class="p">,</span>
</span><span id="__span-11-94"><a id="__codelineno-11-94" name="__codelineno-11-94"></a>            <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="s2">"generate_final_report"</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="s2">"call_analysis"</span><span class="p">)</span>
</span><span id="__span-11-95"><a id="__codelineno-11-95" name="__codelineno-11-95"></a>        <span class="p">)</span>
</span><span id="__span-11-96"><a id="__codelineno-11-96" name="__codelineno-11-96"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-11-97"><a id="__codelineno-11-97" name="__codelineno-11-97"></a>            <span class="s2">"generate_final_report"</span><span class="p">,</span>
</span><span id="__span-11-98"><a id="__codelineno-11-98" name="__codelineno-11-98"></a>            <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="n">END</span><span class="p">,</span> <span class="n">node_name</span><span class="o">=</span><span class="s2">"generate_final_report"</span><span class="p">)</span>
</span><span id="__span-11-99"><a id="__codelineno-11-99" name="__codelineno-11-99"></a>        <span class="p">)</span>
</span><span id="__span-11-100"><a id="__codelineno-11-100" name="__codelineno-11-100"></a>
</span><span id="__span-11-101"><a id="__codelineno-11-101" name="__codelineno-11-101"></a>        <span class="k">return</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div> <div class="language-python highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">main.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span>
<span class="normal"><a href="#__codelineno-12-23">23</a></span>
<span class="normal"><a href="#__codelineno-12-24">24</a></span>
<span class="normal"><a href="#__codelineno-12-25">25</a></span>
<span class="normal"><a href="#__codelineno-12-26">26</a></span>
<span class="normal"><a href="#__codelineno-12-27">27</a></span>
<span class="normal"><a href="#__codelineno-12-28">28</a></span>
<span class="normal"><a href="#__codelineno-12-29">29</a></span>
<span class="normal"><a href="#__codelineno-12-30">30</a></span>
<span class="normal"><a href="#__codelineno-12-31">31</a></span>
<span class="normal"><a href="#__codelineno-12-32">32</a></span>
<span class="normal"><a href="#__codelineno-12-33">33</a></span>
<span class="normal"><a href="#__codelineno-12-34">34</a></span>
<span class="normal"><a href="#__codelineno-12-35">35</a></span>
<span class="normal"><a href="#__codelineno-12-36">36</a></span>
<span class="normal"><a href="#__codelineno-12-37">37</a></span>
<span class="normal"><a href="#__codelineno-12-38">38</a></span>
<span class="normal"><a href="#__codelineno-12-39">39</a></span>
<span class="normal"><a href="#__codelineno-12-40">40</a></span>
<span class="normal"><a href="#__codelineno-12-41">41</a></span>
<span class="normal"><a href="#__codelineno-12-42">42</a></span>
<span class="normal"><a href="#__codelineno-12-43">43</a></span>
<span class="normal"><a href="#__codelineno-12-44">44</a></span>
<span class="normal"><a href="#__codelineno-12-45">45</a></span>
<span class="normal"><a href="#__codelineno-12-46">46</a></span>
<span class="normal"><a href="#__codelineno-12-47">47</a></span>
<span class="normal"><a href="#__codelineno-12-48">48</a></span>
<span class="normal"><a href="#__codelineno-12-49">49</a></span>
<span class="normal"><a href="#__codelineno-12-50">50</a></span>
<span class="normal"><a href="#__codelineno-12-51">51</a></span>
<span class="normal"><a href="#__codelineno-12-52">52</a></span>
<span class="normal"><a href="#__codelineno-12-53">53</a></span>
<span class="normal"><a href="#__codelineno-12-54">54</a></span>
<span class="normal"><a href="#__codelineno-12-55">55</a></span>
<span class="normal"><a href="#__codelineno-12-56">56</a></span>
<span class="normal"><a href="#__codelineno-12-57">57</a></span>
<span class="normal"><a href="#__codelineno-12-58">58</a></span>
<span class="normal"><a href="#__codelineno-12-59">59</a></span>
<span class="normal"><a href="#__codelineno-12-60">60</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">agentic_app.research_service.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_research_graph</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">agentic_app.research_service.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResearchResponse</span><span class="p">,</span> <span class="n">ResearchRequest</span><span class="p">,</span> <span class="n">ResearchState</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a>    <span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Research Service"</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">"1.0.0"</span><span class="p">)</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a>    <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14"></a>        <span class="n">CORSMiddleware</span><span class="p">,</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15"></a>        <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16"></a>        <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17"></a>        <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18"></a>        <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">"*"</span><span class="p">],</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19"></a>    <span class="p">)</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20"></a>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21"></a>    <span class="c1"># Initialize graph</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22"></a>    <span class="n">research_graph</span> <span class="o">=</span> <span class="n">create_research_graph</span><span class="p">()</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23"></a>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24"></a>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25"></a>    <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/research"</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">ResearchResponse</span><span class="p">)</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">conduct_research</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">ResearchRequest</span><span class="p">):</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27"></a><span class="w">        </span><span class="sd">"""Conduct research on a given query"""</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Received research request: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30"></a>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31"></a>            <span class="n">initial_state</span> <span class="o">=</span> <span class="n">ResearchState</span><span class="p">(</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32"></a>                <span class="n">query</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33"></a>                <span class="n">max_retries</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">max_retries</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34"></a>            <span class="p">)</span>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35"></a>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36"></a>            <span class="n">final_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">research_graph</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">initial_state</span><span class="p">)</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37"></a>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38"></a>            <span class="k">return</span> <span class="n">ResearchResponse</span><span class="p">(</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39"></a>                <span class="n">query</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"query"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40"></a>                <span class="n">research_plan</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"research_plan"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41"></a>                <span class="n">search_results</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"search_results"</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42"></a>                <span class="n">summary</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"summary"</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43"></a>                <span class="n">error_messages</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"error_messages"</span><span class="p">,</span> <span class="p">[]),</span>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44"></a>                <span class="n">failed_nodes</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"failed_nodes"</span><span class="p">,</span> <span class="p">{}),</span>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45"></a>                <span class="n">success</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"error_messages"</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46"></a>            <span class="p">)</span>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47"></a>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Research failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51"></a>
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52"></a>
</span><span id="__span-12-53"><a id="__codelineno-12-53" name="__codelineno-12-53"></a>    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/health"</span><span class="p">)</span>
</span><span id="__span-12-54"><a id="__codelineno-12-54" name="__codelineno-12-54"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">():</span>
</span><span id="__span-12-55"><a id="__codelineno-12-55" name="__codelineno-12-55"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">"status"</span><span class="p">:</span> <span class="s2">"healthy"</span><span class="p">,</span> <span class="s2">"service"</span><span class="p">:</span> <span class="s2">"research"</span><span class="p">}</span>
</span><span id="__span-12-56"><a id="__codelineno-12-56" name="__codelineno-12-56"></a>
</span><span id="__span-12-57"><a id="__codelineno-12-57" name="__codelineno-12-57"></a>
</span><span id="__span-12-58"><a id="__codelineno-12-58" name="__codelineno-12-58"></a>    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
</span><span id="__span-12-59"><a id="__codelineno-12-59" name="__codelineno-12-59"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
</span><span id="__span-12-60"><a id="__codelineno-12-60" name="__codelineno-12-60"></a>        <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">"0.0.0.0"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8081</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div> </details> </details> <details> <summary>Others</summary> <div class="language-python highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">error_handler.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">  1</a></span>
<span class="normal"><a href="#__codelineno-13-2">  2</a></span>
<span class="normal"><a href="#__codelineno-13-3">  3</a></span>
<span class="normal"><a href="#__codelineno-13-4">  4</a></span>
<span class="normal"><a href="#__codelineno-13-5">  5</a></span>
<span class="normal"><a href="#__codelineno-13-6">  6</a></span>
<span class="normal"><a href="#__codelineno-13-7">  7</a></span>
<span class="normal"><a href="#__codelineno-13-8">  8</a></span>
<span class="normal"><a href="#__codelineno-13-9">  9</a></span>
<span class="normal"><a href="#__codelineno-13-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-13-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-13-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-13-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-13-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-13-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-13-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-13-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-13-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-13-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-13-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-13-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-13-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-13-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-13-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-13-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-13-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-13-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-13-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-13-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-13-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-13-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-13-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-13-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-13-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-13-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-13-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-13-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-13-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-13-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-13-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-13-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-13-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-13-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-13-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-13-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-13-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-13-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-13-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-13-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-13-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-13-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-13-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-13-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-13-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-13-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-13-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-13-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-13-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-13-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-13-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-13-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-13-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-13-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-13-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-13-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-13-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-13-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-13-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-13-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-13-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-13-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-13-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-13-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-13-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-13-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-13-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-13-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-13-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-13-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-13-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-13-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-13-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-13-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-13-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-13-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-13-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-13-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-13-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-13-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-13-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-13-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-13-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-13-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-13-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-13-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-13-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-13-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-13-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-13-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-13-100">100</a></span>
<span class="normal"><a href="#__codelineno-13-101">101</a></span>
<span class="normal"><a href="#__codelineno-13-102">102</a></span>
<span class="normal"><a href="#__codelineno-13-103">103</a></span>
<span class="normal"><a href="#__codelineno-13-104">104</a></span>
<span class="normal"><a href="#__codelineno-13-105">105</a></span>
<span class="normal"><a href="#__codelineno-13-106">106</a></span>
<span class="normal"><a href="#__codelineno-13-107">107</a></span>
<span class="normal"><a href="#__codelineno-13-108">108</a></span>
<span class="normal"><a href="#__codelineno-13-109">109</a></span>
<span class="normal"><a href="#__codelineno-13-110">110</a></span>
<span class="normal"><a href="#__codelineno-13-111">111</a></span>
<span class="normal"><a href="#__codelineno-13-112">112</a></span>
<span class="normal"><a href="#__codelineno-13-113">113</a></span>
<span class="normal"><a href="#__codelineno-13-114">114</a></span>
<span class="normal"><a href="#__codelineno-13-115">115</a></span>
<span class="normal"><a href="#__codelineno-13-116">116</a></span>
<span class="normal"><a href="#__codelineno-13-117">117</a></span>
<span class="normal"><a href="#__codelineno-13-118">118</a></span>
<span class="normal"><a href="#__codelineno-13-119">119</a></span>
<span class="normal"><a href="#__codelineno-13-120">120</a></span>
<span class="normal"><a href="#__codelineno-13-121">121</a></span>
<span class="normal"><a href="#__codelineno-13-122">122</a></span>
<span class="normal"><a href="#__codelineno-13-123">123</a></span>
<span class="normal"><a href="#__codelineno-13-124">124</a></span>
<span class="normal"><a href="#__codelineno-13-125">125</a></span>
<span class="normal"><a href="#__codelineno-13-126">126</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">ErrorState</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a>    <span class="n">error_messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a>    <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a>    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13"></a>    <span class="n">failed_nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14"></a>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15"></a>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="n">StateType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">'StateType'</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">ErrorState</span><span class="p">)</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17"></a>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18"></a>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">ErrorHandler</span><span class="p">:</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20"></a>    <span class="nd">@staticmethod</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_error</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">StateType</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">custom_message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22"></a>        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">custom_message</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">"Error in </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Node '</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">' failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24"></a>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25"></a>        <span class="n">failed_nodes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26"></a>            <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'failed_nodes'</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'failed_nodes'</span><span class="p">)</span> <span class="k">else</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'failed_nodes'</span><span class="p">,</span> <span class="p">{}))</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27"></a>        <span class="n">node_retry_count</span> <span class="o">=</span> <span class="n">failed_nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28"></a>        <span class="n">failed_nodes</span><span class="p">[</span><span class="n">node_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_retry_count</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29"></a>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30"></a>        <span class="n">retry_count</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'retry_count'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'retry_count'</span><span class="p">)</span> <span class="k">else</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'retry_count'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31"></a>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33"></a>            <span class="s2">"error_messages"</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">"</span><span class="p">],</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34"></a>            <span class="s2">"retry_count"</span><span class="p">:</span> <span class="n">retry_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35"></a>            <span class="s2">"failed_nodes"</span><span class="p">:</span> <span class="n">failed_nodes</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36"></a>        <span class="p">}</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37"></a>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38"></a>    <span class="nd">@staticmethod</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">should_retry</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">StateType</span><span class="p">,</span> <span class="n">node_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40"></a>        <span class="k">if</span> <span class="n">node_name</span><span class="p">:</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41"></a>            <span class="n">failed_nodes</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'failed_nodes'</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'failed_nodes'</span><span class="p">)</span> <span class="k">else</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42"></a>                <span class="s1">'failed_nodes'</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43"></a>            <span class="n">node_retry_count</span> <span class="o">=</span> <span class="n">failed_nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44"></a>            <span class="n">max_retries</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'max_retries'</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'max_retries'</span><span class="p">)</span> <span class="k">else</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45"></a>                <span class="s1">'max_retries'</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46"></a>            <span class="n">error_messages</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'error_messages'</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'error_messages'</span><span class="p">)</span> <span class="k">else</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47"></a>                <span class="s1">'error_messages'</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48"></a>            <span class="n">has_node_error</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">node_name</span> <span class="ow">in</span> <span class="n">msg</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">error_messages</span><span class="p">)</span>
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49"></a>            <span class="k">return</span> <span class="n">node_retry_count</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="ow">and</span> <span class="n">has_node_error</span>
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51"></a>            <span class="n">retry_count</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'retry_count'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'retry_count'</span><span class="p">)</span> <span class="k">else</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52"></a>                <span class="s1">'retry_count'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-13-53"><a id="__codelineno-13-53" name="__codelineno-13-53"></a>            <span class="n">max_retries</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'max_retries'</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'max_retries'</span><span class="p">)</span> <span class="k">else</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="__span-13-54"><a id="__codelineno-13-54" name="__codelineno-13-54"></a>                <span class="s1">'max_retries'</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="__span-13-55"><a id="__codelineno-13-55" name="__codelineno-13-55"></a>            <span class="n">error_messages</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'error_messages'</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">'error_messages'</span><span class="p">)</span> <span class="k">else</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="__span-13-56"><a id="__codelineno-13-56" name="__codelineno-13-56"></a>                <span class="s1">'error_messages'</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-13-57"><a id="__codelineno-13-57" name="__codelineno-13-57"></a>            <span class="k">return</span> <span class="n">retry_count</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="__span-13-58"><a id="__codelineno-13-58" name="__codelineno-13-58"></a>
</span><span id="__span-13-59"><a id="__codelineno-13-59" name="__codelineno-13-59"></a>    <span class="nd">@staticmethod</span>
</span><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_errors</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">StateType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-13-61"><a id="__codelineno-13-61" name="__codelineno-13-61"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-13-62"><a id="__codelineno-13-62" name="__codelineno-13-62"></a>            <span class="s2">"error_messages"</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-13-63"><a id="__codelineno-13-63" name="__codelineno-13-63"></a>            <span class="s2">"retry_count"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-13-64"><a id="__codelineno-13-64" name="__codelineno-13-64"></a>        <span class="p">}</span>
</span><span id="__span-13-65"><a id="__codelineno-13-65" name="__codelineno-13-65"></a>
</span><span id="__span-13-66"><a id="__codelineno-13-66" name="__codelineno-13-66"></a>
</span><span id="__span-13-67"><a id="__codelineno-13-67" name="__codelineno-13-67"></a><span class="k">def</span><span class="w"> </span><span class="nf">handle_node_errors</span><span class="p">(</span><span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">custom_message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-13-68"><a id="__codelineno-13-68" name="__codelineno-13-68"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
</span><span id="__span-13-69"><a id="__codelineno-13-69" name="__codelineno-13-69"></a>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span id="__span-13-70"><a id="__codelineno-13-70" name="__codelineno-13-70"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">StateType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-13-71"><a id="__codelineno-13-71" name="__codelineno-13-71"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-13-72"><a id="__codelineno-13-72" name="__codelineno-13-72"></a>                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="__span-13-73"><a id="__codelineno-13-73" name="__codelineno-13-73"></a>                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-13-74"><a id="__codelineno-13-74" name="__codelineno-13-74"></a>                    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-13-75"><a id="__codelineno-13-75" name="__codelineno-13-75"></a>                <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ErrorHandler</span><span class="o">.</span><span class="n">clear_errors</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
</span><span id="__span-13-76"><a id="__codelineno-13-76" name="__codelineno-13-76"></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-13-77"><a id="__codelineno-13-77" name="__codelineno-13-77"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-13-78"><a id="__codelineno-13-78" name="__codelineno-13-78"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error in async node '</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
</span><span id="__span-13-79"><a id="__codelineno-13-79" name="__codelineno-13-79"></a>                <span class="k">return</span> <span class="n">ErrorHandler</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">custom_message</span><span class="p">)</span>
</span><span id="__span-13-80"><a id="__codelineno-13-80" name="__codelineno-13-80"></a>
</span><span id="__span-13-81"><a id="__codelineno-13-81" name="__codelineno-13-81"></a>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span id="__span-13-82"><a id="__codelineno-13-82" name="__codelineno-13-82"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">sync_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">StateType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-13-83"><a id="__codelineno-13-83" name="__codelineno-13-83"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-13-84"><a id="__codelineno-13-84" name="__codelineno-13-84"></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="__span-13-85"><a id="__codelineno-13-85" name="__codelineno-13-85"></a>                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-13-86"><a id="__codelineno-13-86" name="__codelineno-13-86"></a>                    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-13-87"><a id="__codelineno-13-87" name="__codelineno-13-87"></a>                <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ErrorHandler</span><span class="o">.</span><span class="n">clear_errors</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
</span><span id="__span-13-88"><a id="__codelineno-13-88" name="__codelineno-13-88"></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-13-89"><a id="__codelineno-13-89" name="__codelineno-13-89"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-13-90"><a id="__codelineno-13-90" name="__codelineno-13-90"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error in sync node '</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
</span><span id="__span-13-91"><a id="__codelineno-13-91" name="__codelineno-13-91"></a>                <span class="k">return</span> <span class="n">ErrorHandler</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">custom_message</span><span class="p">)</span>
</span><span id="__span-13-92"><a id="__codelineno-13-92" name="__codelineno-13-92"></a>
</span><span id="__span-13-93"><a id="__codelineno-13-93" name="__codelineno-13-93"></a>        <span class="k">if</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="__span-13-94"><a id="__codelineno-13-94" name="__codelineno-13-94"></a>            <span class="k">return</span> <span class="n">async_wrapper</span>
</span><span id="__span-13-95"><a id="__codelineno-13-95" name="__codelineno-13-95"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-13-96"><a id="__codelineno-13-96" name="__codelineno-13-96"></a>            <span class="k">return</span> <span class="n">sync_wrapper</span>
</span><span id="__span-13-97"><a id="__codelineno-13-97" name="__codelineno-13-97"></a>
</span><span id="__span-13-98"><a id="__codelineno-13-98" name="__codelineno-13-98"></a>    <span class="k">return</span> <span class="n">decorator</span>
</span><span id="__span-13-99"><a id="__codelineno-13-99" name="__codelineno-13-99"></a>
</span><span id="__span-13-100"><a id="__codelineno-13-100" name="__codelineno-13-100"></a>
</span><span id="__span-13-101"><a id="__codelineno-13-101" name="__codelineno-13-101"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end_node</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"END"</span><span class="p">,</span> <span class="n">node_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-13-102"><a id="__codelineno-13-102" name="__codelineno-13-102"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-13-103"><a id="__codelineno-13-103" name="__codelineno-13-103"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-13-104"><a id="__codelineno-13-104" name="__codelineno-13-104"></a>            <span class="n">error_messages</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'error_messages'</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-13-105"><a id="__codelineno-13-105" name="__codelineno-13-105"></a>            <span class="n">max_retries</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'max_retries'</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="__span-13-106"><a id="__codelineno-13-106" name="__codelineno-13-106"></a>            <span class="n">failed_nodes</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'failed_nodes'</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-13-107"><a id="__codelineno-13-107" name="__codelineno-13-107"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-13-108"><a id="__codelineno-13-108" name="__codelineno-13-108"></a>            <span class="n">error_messages</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">error_messages</span>
</span><span id="__span-13-109"><a id="__codelineno-13-109" name="__codelineno-13-109"></a>            <span class="n">max_retries</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">max_retries</span>
</span><span id="__span-13-110"><a id="__codelineno-13-110" name="__codelineno-13-110"></a>            <span class="n">failed_nodes</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">failed_nodes</span>
</span><span id="__span-13-111"><a id="__codelineno-13-111" name="__codelineno-13-111"></a>
</span><span id="__span-13-112"><a id="__codelineno-13-112" name="__codelineno-13-112"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">node_name</span><span class="p">:</span>
</span><span id="__span-13-113"><a id="__codelineno-13-113" name="__codelineno-13-113"></a>            <span class="n">has_node_error</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">node_name</span> <span class="ow">in</span> <span class="n">msg</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">error_messages</span><span class="p">)</span>
</span><span id="__span-13-114"><a id="__codelineno-13-114" name="__codelineno-13-114"></a>
</span><span id="__span-13-115"><a id="__codelineno-13-115" name="__codelineno-13-115"></a>            <span class="k">if</span> <span class="n">has_node_error</span><span class="p">:</span>
</span><span id="__span-13-116"><a id="__codelineno-13-116" name="__codelineno-13-116"></a>                <span class="n">node_retry_count</span> <span class="o">=</span> <span class="n">failed_nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-13-117"><a id="__codelineno-13-117" name="__codelineno-13-117"></a>                <span class="k">if</span> <span class="n">node_retry_count</span> <span class="o">&lt;</span> <span class="n">max_retries</span><span class="p">:</span>
</span><span id="__span-13-118"><a id="__codelineno-13-118" name="__codelineno-13-118"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Retrying </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">, attempt </span><span class="si">{</span><span class="n">node_retry_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-13-119"><a id="__codelineno-13-119" name="__codelineno-13-119"></a>                    <span class="k">return</span> <span class="n">node_name</span>
</span><span id="__span-13-120"><a id="__codelineno-13-120" name="__codelineno-13-120"></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="__span-13-121"><a id="__codelineno-13-121" name="__codelineno-13-121"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Max retries reached for </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">, ending execution"</span><span class="p">)</span>
</span><span id="__span-13-122"><a id="__codelineno-13-122" name="__codelineno-13-122"></a>                    <span class="k">return</span> <span class="n">end_node</span>
</span><span id="__span-13-123"><a id="__codelineno-13-123" name="__codelineno-13-123"></a>
</span><span id="__span-13-124"><a id="__codelineno-13-124" name="__codelineno-13-124"></a>        <span class="k">return</span> <span class="n">next_node</span>
</span><span id="__span-13-125"><a id="__codelineno-13-125" name="__codelineno-13-125"></a>
</span><span id="__span-13-126"><a id="__codelineno-13-126" name="__codelineno-13-126"></a>    <span class="k">return</span> <span class="n">router</span>
</span></code></pre></div></td></tr></table></div> <div class="language-sh highlight"><table class="highlighttable"><tr><th class="filename" colspan="2"><span class="filename">run_services.sh</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1"># Terminal 1 - Research Service</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nb">cd</span><span class="w"> </span>research_service
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a>uvicorn<span class="w"> </span>main:app<span class="w"> </span>--reload<span class="w"> </span>--port<span class="w"> </span><span class="m">8001</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="c1"># Terminal 2 - Analysis Service</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="nb">cd</span><span class="w"> </span>analysis_service
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a>uvicorn<span class="w"> </span>main:app<span class="w"> </span>--reload<span class="w"> </span>--port<span class="w"> </span><span class="m">8002</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="c1"># Terminal 3 - Supervisor Service</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="nb">cd</span><span class="w"> </span>supervisor_service
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a>uvicorn<span class="w"> </span>main:app<span class="w"> </span>--reload<span class="w"> </span>--port<span class="w"> </span><span class="m">8000</span>
</span></code></pre></div></td></tr></table></div> </details> <h2 id="codes-explanation"><del>Codes Explanation</del><a class="headerlink" href="#codes-explanation" title="Permanent link">#</a></h2> <details> <summary>Full Code(old)</summary> <details class="graph"> <summary>Graph</summary> <pre class="mermaid"><code>  graph TD
    Start([Start]) --&gt; ValidateQuery[Validate Query]

    ValidateQuery --&gt;|Success| CreatePlan[Create Research Plan]
    ValidateQuery --&gt;|Error &amp; Retries| ValidateQuery
    ValidateQuery --&gt;|Error &amp; Max Retries| End([End])

    CreatePlan --&gt;|Success| GatherInfo[Gather Information]
    CreatePlan --&gt;|Error &amp; Retries| CreatePlan
    CreatePlan --&gt;|Error &amp; Max Retries| End

    GatherInfo --&gt;|Success| Synthesize[Synthesize Findings]
    GatherInfo --&gt;|Error &amp; Retries| GatherInfo
    GatherInfo --&gt;|Error &amp; Max Retries| End

    Synthesize --&gt;|Success| GenerateReport[Generate Report]
    Synthesize --&gt;|Error &amp; Retries| Synthesize
    Synthesize --&gt;|Error &amp; Max Retries| End

    GenerateReport --&gt;|Success| End
    GenerateReport --&gt;|Error &amp; Retries| GenerateReport
    GenerateReport --&gt;|Error &amp; Max Retries| End

    style ValidateQuery fill:#e1f5ff
    style CreatePlan fill:#e1f5ff
    style GatherInfo fill:#e1f5ff
    style Synthesize fill:#e1f5ff
    style GenerateReport fill:#e1f5ff
    style Start fill:#d4edda
    style End fill:#f8d7da
</code></pre> </details> <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">  1</a></span>
<span class="normal"><a href="#__codelineno-15-2">  2</a></span>
<span class="normal"><a href="#__codelineno-15-3">  3</a></span>
<span class="normal"><a href="#__codelineno-15-4">  4</a></span>
<span class="normal"><a href="#__codelineno-15-5">  5</a></span>
<span class="normal"><a href="#__codelineno-15-6">  6</a></span>
<span class="normal"><a href="#__codelineno-15-7">  7</a></span>
<span class="normal"><a href="#__codelineno-15-8">  8</a></span>
<span class="normal"><a href="#__codelineno-15-9">  9</a></span>
<span class="normal"><a href="#__codelineno-15-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-15-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-15-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-15-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-15-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-15-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-15-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-15-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-15-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-15-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-15-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-15-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-15-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-15-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-15-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-15-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-15-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-15-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-15-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-15-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-15-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-15-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-15-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-15-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-15-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-15-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-15-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-15-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-15-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-15-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-15-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-15-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-15-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-15-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-15-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-15-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-15-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-15-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-15-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-15-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-15-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-15-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-15-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-15-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-15-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-15-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-15-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-15-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-15-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-15-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-15-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-15-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-15-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-15-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-15-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-15-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-15-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-15-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-15-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-15-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-15-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-15-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-15-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-15-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-15-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-15-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-15-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-15-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-15-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-15-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-15-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-15-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-15-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-15-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-15-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-15-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-15-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-15-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-15-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-15-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-15-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-15-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-15-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-15-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-15-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-15-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-15-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-15-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-15-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-15-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-15-100">100</a></span>
<span class="normal"><a href="#__codelineno-15-101">101</a></span>
<span class="normal"><a href="#__codelineno-15-102">102</a></span>
<span class="normal"><a href="#__codelineno-15-103">103</a></span>
<span class="normal"><a href="#__codelineno-15-104">104</a></span>
<span class="normal"><a href="#__codelineno-15-105">105</a></span>
<span class="normal"><a href="#__codelineno-15-106">106</a></span>
<span class="normal"><a href="#__codelineno-15-107">107</a></span>
<span class="normal"><a href="#__codelineno-15-108">108</a></span>
<span class="normal"><a href="#__codelineno-15-109">109</a></span>
<span class="normal"><a href="#__codelineno-15-110">110</a></span>
<span class="normal"><a href="#__codelineno-15-111">111</a></span>
<span class="normal"><a href="#__codelineno-15-112">112</a></span>
<span class="normal"><a href="#__codelineno-15-113">113</a></span>
<span class="normal"><a href="#__codelineno-15-114">114</a></span>
<span class="normal"><a href="#__codelineno-15-115">115</a></span>
<span class="normal"><a href="#__codelineno-15-116">116</a></span>
<span class="normal"><a href="#__codelineno-15-117">117</a></span>
<span class="normal"><a href="#__codelineno-15-118">118</a></span>
<span class="normal"><a href="#__codelineno-15-119">119</a></span>
<span class="normal"><a href="#__codelineno-15-120">120</a></span>
<span class="normal"><a href="#__codelineno-15-121">121</a></span>
<span class="normal"><a href="#__codelineno-15-122">122</a></span>
<span class="normal"><a href="#__codelineno-15-123">123</a></span>
<span class="normal"><a href="#__codelineno-15-124">124</a></span>
<span class="normal"><a href="#__codelineno-15-125">125</a></span>
<span class="normal"><a href="#__codelineno-15-126">126</a></span>
<span class="normal"><a href="#__codelineno-15-127">127</a></span>
<span class="normal"><a href="#__codelineno-15-128">128</a></span>
<span class="normal"><a href="#__codelineno-15-129">129</a></span>
<span class="normal"><a href="#__codelineno-15-130">130</a></span>
<span class="normal"><a href="#__codelineno-15-131">131</a></span>
<span class="normal"><a href="#__codelineno-15-132">132</a></span>
<span class="normal"><a href="#__codelineno-15-133">133</a></span>
<span class="normal"><a href="#__codelineno-15-134">134</a></span>
<span class="normal"><a href="#__codelineno-15-135">135</a></span>
<span class="normal"><a href="#__codelineno-15-136">136</a></span>
<span class="normal"><a href="#__codelineno-15-137">137</a></span>
<span class="normal"><a href="#__codelineno-15-138">138</a></span>
<span class="normal"><a href="#__codelineno-15-139">139</a></span>
<span class="normal"><a href="#__codelineno-15-140">140</a></span>
<span class="normal"><a href="#__codelineno-15-141">141</a></span>
<span class="normal"><a href="#__codelineno-15-142">142</a></span>
<span class="normal"><a href="#__codelineno-15-143">143</a></span>
<span class="normal"><a href="#__codelineno-15-144">144</a></span>
<span class="normal"><a href="#__codelineno-15-145">145</a></span>
<span class="normal"><a href="#__codelineno-15-146">146</a></span>
<span class="normal"><a href="#__codelineno-15-147">147</a></span>
<span class="normal"><a href="#__codelineno-15-148">148</a></span>
<span class="normal"><a href="#__codelineno-15-149">149</a></span>
<span class="normal"><a href="#__codelineno-15-150">150</a></span>
<span class="normal"><a href="#__codelineno-15-151">151</a></span>
<span class="normal"><a href="#__codelineno-15-152">152</a></span>
<span class="normal"><a href="#__codelineno-15-153">153</a></span>
<span class="normal"><a href="#__codelineno-15-154">154</a></span>
<span class="normal"><a href="#__codelineno-15-155">155</a></span>
<span class="normal"><a href="#__codelineno-15-156">156</a></span>
<span class="normal"><a href="#__codelineno-15-157">157</a></span>
<span class="normal"><a href="#__codelineno-15-158">158</a></span>
<span class="normal"><a href="#__codelineno-15-159">159</a></span>
<span class="normal"><a href="#__codelineno-15-160">160</a></span>
<span class="normal"><a href="#__codelineno-15-161">161</a></span>
<span class="normal"><a href="#__codelineno-15-162">162</a></span>
<span class="normal"><a href="#__codelineno-15-163">163</a></span>
<span class="normal"><a href="#__codelineno-15-164">164</a></span>
<span class="normal"><a href="#__codelineno-15-165">165</a></span>
<span class="normal"><a href="#__codelineno-15-166">166</a></span>
<span class="normal"><a href="#__codelineno-15-167">167</a></span>
<span class="normal"><a href="#__codelineno-15-168">168</a></span>
<span class="normal"><a href="#__codelineno-15-169">169</a></span>
<span class="normal"><a href="#__codelineno-15-170">170</a></span>
<span class="normal"><a href="#__codelineno-15-171">171</a></span>
<span class="normal"><a href="#__codelineno-15-172">172</a></span>
<span class="normal"><a href="#__codelineno-15-173">173</a></span>
<span class="normal"><a href="#__codelineno-15-174">174</a></span>
<span class="normal"><a href="#__codelineno-15-175">175</a></span>
<span class="normal"><a href="#__codelineno-15-176">176</a></span>
<span class="normal"><a href="#__codelineno-15-177">177</a></span>
<span class="normal"><a href="#__codelineno-15-178">178</a></span>
<span class="normal"><a href="#__codelineno-15-179">179</a></span>
<span class="normal"><a href="#__codelineno-15-180">180</a></span>
<span class="normal"><a href="#__codelineno-15-181">181</a></span>
<span class="normal"><a href="#__codelineno-15-182">182</a></span>
<span class="normal"><a href="#__codelineno-15-183">183</a></span>
<span class="normal"><a href="#__codelineno-15-184">184</a></span>
<span class="normal"><a href="#__codelineno-15-185">185</a></span>
<span class="normal"><a href="#__codelineno-15-186">186</a></span>
<span class="normal"><a href="#__codelineno-15-187">187</a></span>
<span class="normal"><a href="#__codelineno-15-188">188</a></span>
<span class="normal"><a href="#__codelineno-15-189">189</a></span>
<span class="normal"><a href="#__codelineno-15-190">190</a></span>
<span class="normal"><a href="#__codelineno-15-191">191</a></span>
<span class="normal"><a href="#__codelineno-15-192">192</a></span>
<span class="normal"><a href="#__codelineno-15-193">193</a></span>
<span class="normal"><a href="#__codelineno-15-194">194</a></span>
<span class="normal"><a href="#__codelineno-15-195">195</a></span>
<span class="normal"><a href="#__codelineno-15-196">196</a></span>
<span class="normal"><a href="#__codelineno-15-197">197</a></span>
<span class="normal"><a href="#__codelineno-15-198">198</a></span>
<span class="normal"><a href="#__codelineno-15-199">199</a></span>
<span class="normal"><a href="#__codelineno-15-200">200</a></span>
<span class="normal"><a href="#__codelineno-15-201">201</a></span>
<span class="normal"><a href="#__codelineno-15-202">202</a></span>
<span class="normal"><a href="#__codelineno-15-203">203</a></span>
<span class="normal"><a href="#__codelineno-15-204">204</a></span>
<span class="normal"><a href="#__codelineno-15-205">205</a></span>
<span class="normal"><a href="#__codelineno-15-206">206</a></span>
<span class="normal"><a href="#__codelineno-15-207">207</a></span>
<span class="normal"><a href="#__codelineno-15-208">208</a></span>
<span class="normal"><a href="#__codelineno-15-209">209</a></span>
<span class="normal"><a href="#__codelineno-15-210">210</a></span>
<span class="normal"><a href="#__codelineno-15-211">211</a></span>
<span class="normal"><a href="#__codelineno-15-212">212</a></span>
<span class="normal"><a href="#__codelineno-15-213">213</a></span>
<span class="normal"><a href="#__codelineno-15-214">214</a></span>
<span class="normal"><a href="#__codelineno-15-215">215</a></span>
<span class="normal"><a href="#__codelineno-15-216">216</a></span>
<span class="normal"><a href="#__codelineno-15-217">217</a></span>
<span class="normal"><a href="#__codelineno-15-218">218</a></span>
<span class="normal"><a href="#__codelineno-15-219">219</a></span>
<span class="normal"><a href="#__codelineno-15-220">220</a></span>
<span class="normal"><a href="#__codelineno-15-221">221</a></span>
<span class="normal"><a href="#__codelineno-15-222">222</a></span>
<span class="normal"><a href="#__codelineno-15-223">223</a></span>
<span class="normal"><a href="#__codelineno-15-224">224</a></span>
<span class="normal"><a href="#__codelineno-15-225">225</a></span>
<span class="normal"><a href="#__codelineno-15-226">226</a></span>
<span class="normal"><a href="#__codelineno-15-227">227</a></span>
<span class="normal"><a href="#__codelineno-15-228">228</a></span>
<span class="normal"><a href="#__codelineno-15-229">229</a></span>
<span class="normal"><a href="#__codelineno-15-230">230</a></span>
<span class="normal"><a href="#__codelineno-15-231">231</a></span>
<span class="normal"><a href="#__codelineno-15-232">232</a></span>
<span class="normal"><a href="#__codelineno-15-233">233</a></span>
<span class="normal"><a href="#__codelineno-15-234">234</a></span>
<span class="normal"><a href="#__codelineno-15-235">235</a></span>
<span class="normal"><a href="#__codelineno-15-236">236</a></span>
<span class="normal"><a href="#__codelineno-15-237">237</a></span>
<span class="normal"><a href="#__codelineno-15-238">238</a></span>
<span class="normal"><a href="#__codelineno-15-239">239</a></span>
<span class="normal"><a href="#__codelineno-15-240">240</a></span>
<span class="normal"><a href="#__codelineno-15-241">241</a></span>
<span class="normal"><a href="#__codelineno-15-242">242</a></span>
<span class="normal"><a href="#__codelineno-15-243">243</a></span>
<span class="normal"><a href="#__codelineno-15-244">244</a></span>
<span class="normal"><a href="#__codelineno-15-245">245</a></span>
<span class="normal"><a href="#__codelineno-15-246">246</a></span>
<span class="normal"><a href="#__codelineno-15-247">247</a></span>
<span class="normal"><a href="#__codelineno-15-248">248</a></span>
<span class="normal"><a href="#__codelineno-15-249">249</a></span>
<span class="normal"><a href="#__codelineno-15-250">250</a></span>
<span class="normal"><a href="#__codelineno-15-251">251</a></span>
<span class="normal"><a href="#__codelineno-15-252">252</a></span>
<span class="normal"><a href="#__codelineno-15-253">253</a></span>
<span class="normal"><a href="#__codelineno-15-254">254</a></span>
<span class="normal"><a href="#__codelineno-15-255">255</a></span>
<span class="normal"><a href="#__codelineno-15-256">256</a></span>
<span class="normal"><a href="#__codelineno-15-257">257</a></span>
<span class="normal"><a href="#__codelineno-15-258">258</a></span>
<span class="normal"><a href="#__codelineno-15-259">259</a></span>
<span class="normal"><a href="#__codelineno-15-260">260</a></span>
<span class="normal"><a href="#__codelineno-15-261">261</a></span>
<span class="normal"><a href="#__codelineno-15-262">262</a></span>
<span class="normal"><a href="#__codelineno-15-263">263</a></span>
<span class="normal"><a href="#__codelineno-15-264">264</a></span>
<span class="normal"><a href="#__codelineno-15-265">265</a></span>
<span class="normal"><a href="#__codelineno-15-266">266</a></span>
<span class="normal"><a href="#__codelineno-15-267">267</a></span>
<span class="normal"><a href="#__codelineno-15-268">268</a></span>
<span class="normal"><a href="#__codelineno-15-269">269</a></span>
<span class="normal"><a href="#__codelineno-15-270">270</a></span>
<span class="normal"><a href="#__codelineno-15-271">271</a></span>
<span class="normal"><a href="#__codelineno-15-272">272</a></span>
<span class="normal"><a href="#__codelineno-15-273">273</a></span>
<span class="normal"><a href="#__codelineno-15-274">274</a></span>
<span class="normal"><a href="#__codelineno-15-275">275</a></span>
<span class="normal"><a href="#__codelineno-15-276">276</a></span>
<span class="normal"><a href="#__codelineno-15-277">277</a></span>
<span class="normal"><a href="#__codelineno-15-278">278</a></span>
<span class="normal"><a href="#__codelineno-15-279">279</a></span>
<span class="normal"><a href="#__codelineno-15-280">280</a></span>
<span class="normal"><a href="#__codelineno-15-281">281</a></span>
<span class="normal"><a href="#__codelineno-15-282">282</a></span>
<span class="normal"><a href="#__codelineno-15-283">283</a></span>
<span class="normal"><a href="#__codelineno-15-284">284</a></span>
<span class="normal"><a href="#__codelineno-15-285">285</a></span>
<span class="normal"><a href="#__codelineno-15-286">286</a></span>
<span class="normal"><a href="#__codelineno-15-287">287</a></span>
<span class="normal"><a href="#__codelineno-15-288">288</a></span>
<span class="normal"><a href="#__codelineno-15-289">289</a></span>
<span class="normal"><a href="#__codelineno-15-290">290</a></span>
<span class="normal"><a href="#__codelineno-15-291">291</a></span>
<span class="normal"><a href="#__codelineno-15-292">292</a></span>
<span class="normal"><a href="#__codelineno-15-293">293</a></span>
<span class="normal"><a href="#__codelineno-15-294">294</a></span>
<span class="normal"><a href="#__codelineno-15-295">295</a></span>
<span class="normal"><a href="#__codelineno-15-296">296</a></span>
<span class="normal"><a href="#__codelineno-15-297">297</a></span>
<span class="normal"><a href="#__codelineno-15-298">298</a></span>
<span class="normal"><a href="#__codelineno-15-299">299</a></span>
<span class="normal"><a href="#__codelineno-15-300">300</a></span>
<span class="normal"><a href="#__codelineno-15-301">301</a></span>
<span class="normal"><a href="#__codelineno-15-302">302</a></span>
<span class="normal"><a href="#__codelineno-15-303">303</a></span>
<span class="normal"><a href="#__codelineno-15-304">304</a></span>
<span class="normal"><a href="#__codelineno-15-305">305</a></span>
<span class="normal"><a href="#__codelineno-15-306">306</a></span>
<span class="normal"><a href="#__codelineno-15-307">307</a></span>
<span class="normal"><a href="#__codelineno-15-308">308</a></span>
<span class="normal"><a href="#__codelineno-15-309">309</a></span>
<span class="normal"><a href="#__codelineno-15-310">310</a></span>
<span class="normal"><a href="#__codelineno-15-311">311</a></span>
<span class="normal"><a href="#__codelineno-15-312">312</a></span>
<span class="normal"><a href="#__codelineno-15-313">313</a></span>
<span class="normal"><a href="#__codelineno-15-314">314</a></span>
<span class="normal"><a href="#__codelineno-15-315">315</a></span>
<span class="normal"><a href="#__codelineno-15-316">316</a></span>
<span class="normal"><a href="#__codelineno-15-317">317</a></span>
<span class="normal"><a href="#__codelineno-15-318">318</a></span>
<span class="normal"><a href="#__codelineno-15-319">319</a></span>
<span class="normal"><a href="#__codelineno-15-320">320</a></span>
<span class="normal"><a href="#__codelineno-15-321">321</a></span>
<span class="normal"><a href="#__codelineno-15-322">322</a></span>
<span class="normal"><a href="#__codelineno-15-323">323</a></span>
<span class="normal"><a href="#__codelineno-15-324">324</a></span>
<span class="normal"><a href="#__codelineno-15-325">325</a></span>
<span class="normal"><a href="#__codelineno-15-326">326</a></span>
<span class="normal"><a href="#__codelineno-15-327">327</a></span>
<span class="normal"><a href="#__codelineno-15-328">328</a></span>
<span class="normal"><a href="#__codelineno-15-329">329</a></span>
<span class="normal"><a href="#__codelineno-15-330">330</a></span>
<span class="normal"><a href="#__codelineno-15-331">331</a></span>
<span class="normal"><a href="#__codelineno-15-332">332</a></span>
<span class="normal"><a href="#__codelineno-15-333">333</a></span>
<span class="normal"><a href="#__codelineno-15-334">334</a></span>
<span class="normal"><a href="#__codelineno-15-335">335</a></span>
<span class="normal"><a href="#__codelineno-15-336">336</a></span>
<span class="normal"><a href="#__codelineno-15-337">337</a></span>
<span class="normal"><a href="#__codelineno-15-338">338</a></span>
<span class="normal"><a href="#__codelineno-15-339">339</a></span>
<span class="normal"><a href="#__codelineno-15-340">340</a></span>
<span class="normal"><a href="#__codelineno-15-341">341</a></span>
<span class="normal"><a href="#__codelineno-15-342">342</a></span>
<span class="normal"><a href="#__codelineno-15-343">343</a></span>
<span class="normal"><a href="#__codelineno-15-344">344</a></span>
<span class="normal"><a href="#__codelineno-15-345">345</a></span>
<span class="normal"><a href="#__codelineno-15-346">346</a></span>
<span class="normal"><a href="#__codelineno-15-347">347</a></span>
<span class="normal"><a href="#__codelineno-15-348">348</a></span>
<span class="normal"><a href="#__codelineno-15-349">349</a></span>
<span class="normal"><a href="#__codelineno-15-350">350</a></span>
<span class="normal"><a href="#__codelineno-15-351">351</a></span>
<span class="normal"><a href="#__codelineno-15-352">352</a></span>
<span class="normal"><a href="#__codelineno-15-353">353</a></span>
<span class="normal"><a href="#__codelineno-15-354">354</a></span>
<span class="normal"><a href="#__codelineno-15-355">355</a></span>
<span class="normal"><a href="#__codelineno-15-356">356</a></span>
<span class="normal"><a href="#__codelineno-15-357">357</a></span>
<span class="normal"><a href="#__codelineno-15-358">358</a></span>
<span class="normal"><a href="#__codelineno-15-359">359</a></span>
<span class="normal"><a href="#__codelineno-15-360">360</a></span>
<span class="normal"><a href="#__codelineno-15-361">361</a></span>
<span class="normal"><a href="#__codelineno-15-362">362</a></span>
<span class="normal"><a href="#__codelineno-15-363">363</a></span>
<span class="normal"><a href="#__codelineno-15-364">364</a></span>
<span class="normal"><a href="#__codelineno-15-365">365</a></span>
<span class="normal"><a href="#__codelineno-15-366">366</a></span>
<span class="normal"><a href="#__codelineno-15-367">367</a></span>
<span class="normal"><a href="#__codelineno-15-368">368</a></span>
<span class="normal"><a href="#__codelineno-15-369">369</a></span>
<span class="normal"><a href="#__codelineno-15-370">370</a></span>
<span class="normal"><a href="#__codelineno-15-371">371</a></span>
<span class="normal"><a href="#__codelineno-15-372">372</a></span>
<span class="normal"><a href="#__codelineno-15-373">373</a></span>
<span class="normal"><a href="#__codelineno-15-374">374</a></span>
<span class="normal"><a href="#__codelineno-15-375">375</a></span>
<span class="normal"><a href="#__codelineno-15-376">376</a></span>
<span class="normal"><a href="#__codelineno-15-377">377</a></span>
<span class="normal"><a href="#__codelineno-15-378">378</a></span>
<span class="normal"><a href="#__codelineno-15-379">379</a></span>
<span class="normal"><a href="#__codelineno-15-380">380</a></span>
<span class="normal"><a href="#__codelineno-15-381">381</a></span>
<span class="normal"><a href="#__codelineno-15-382">382</a></span>
<span class="normal"><a href="#__codelineno-15-383">383</a></span>
<span class="normal"><a href="#__codelineno-15-384">384</a></span>
<span class="normal"><a href="#__codelineno-15-385">385</a></span>
<span class="normal"><a href="#__codelineno-15-386">386</a></span>
<span class="normal"><a href="#__codelineno-15-387">387</a></span>
<span class="normal"><a href="#__codelineno-15-388">388</a></span>
<span class="normal"><a href="#__codelineno-15-389">389</a></span>
<span class="normal"><a href="#__codelineno-15-390">390</a></span>
<span class="normal"><a href="#__codelineno-15-391">391</a></span>
<span class="normal"><a href="#__codelineno-15-392">392</a></span>
<span class="normal"><a href="#__codelineno-15-393">393</a></span>
<span class="normal"><a href="#__codelineno-15-394">394</a></span>
<span class="normal"><a href="#__codelineno-15-395">395</a></span>
<span class="normal"><a href="#__codelineno-15-396">396</a></span>
<span class="normal"><a href="#__codelineno-15-397">397</a></span>
<span class="normal"><a href="#__codelineno-15-398">398</a></span>
<span class="normal"><a href="#__codelineno-15-399">399</a></span>
<span class="normal"><a href="#__codelineno-15-400">400</a></span>
<span class="normal"><a href="#__codelineno-15-401">401</a></span>
<span class="normal"><a href="#__codelineno-15-402">402</a></span>
<span class="normal"><a href="#__codelineno-15-403">403</a></span>
<span class="normal"><a href="#__codelineno-15-404">404</a></span>
<span class="normal"><a href="#__codelineno-15-405">405</a></span>
<span class="normal"><a href="#__codelineno-15-406">406</a></span>
<span class="normal"><a href="#__codelineno-15-407">407</a></span>
<span class="normal"><a href="#__codelineno-15-408">408</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Annotated</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">END</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_ollama</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOllama</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">SystemMessage</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">CompiledStateGraph</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13"></a>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14"></a>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="c1"># ERROR HANDLER (from your code)</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18"></a>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">ErrorState</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20"></a>    <span class="n">error_messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21"></a>    <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22"></a>    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23"></a>    <span class="n">last_failed_node</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24"></a>    <span class="n">current_node</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25"></a>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26"></a>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27"></a><span class="n">StateType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">'StateType'</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">ErrorState</span><span class="p">)</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28"></a>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29"></a>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30"></a><span class="k">class</span><span class="w"> </span><span class="nc">ErrorHandler</span><span class="p">:</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31"></a>    <span class="nd">@staticmethod</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">handle_error</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">StateType</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">custom_message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33"></a>        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">custom_message</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">"Error in </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Node '</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">' failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35"></a>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37"></a>            <span class="s2">"error_messages"</span><span class="p">:</span> <span class="p">[</span><span class="n">error_msg</span><span class="p">],</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38"></a>            <span class="s2">"retry_count"</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">retry_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39"></a>            <span class="s2">"last_failed_node"</span><span class="p">:</span> <span class="n">node_name</span><span class="p">,</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40"></a>            <span class="s2">"current_node"</span><span class="p">:</span> <span class="n">node_name</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41"></a>        <span class="p">}</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42"></a>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43"></a>    <span class="nd">@staticmethod</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">should_retry</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">StateType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45"></a>        <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">retry_count</span> <span class="o">&lt;</span> <span class="n">state</span><span class="o">.</span><span class="n">max_retries</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">error_messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46"></a>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47"></a>    <span class="nd">@staticmethod</span>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_errors</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">StateType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50"></a>            <span class="s2">"error_messages"</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="__span-15-51"><a id="__codelineno-15-51" name="__codelineno-15-51"></a>            <span class="s2">"retry_count"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-15-52"><a id="__codelineno-15-52" name="__codelineno-15-52"></a>            <span class="s2">"last_failed_node"</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-15-53"><a id="__codelineno-15-53" name="__codelineno-15-53"></a>        <span class="p">}</span>
</span><span id="__span-15-54"><a id="__codelineno-15-54" name="__codelineno-15-54"></a>
</span><span id="__span-15-55"><a id="__codelineno-15-55" name="__codelineno-15-55"></a>    <span class="nd">@staticmethod</span>
</span><span id="__span-15-56"><a id="__codelineno-15-56" name="__codelineno-15-56"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_error_summary</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">StateType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-15-57"><a id="__codelineno-15-57" name="__codelineno-15-57"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-15-58"><a id="__codelineno-15-58" name="__codelineno-15-58"></a>            <span class="s2">"has_errors"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">error_messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-15-59"><a id="__codelineno-15-59" name="__codelineno-15-59"></a>            <span class="s2">"error_count"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">error_messages</span><span class="p">),</span>
</span><span id="__span-15-60"><a id="__codelineno-15-60" name="__codelineno-15-60"></a>            <span class="s2">"retry_count"</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">retry_count</span><span class="p">,</span>
</span><span id="__span-15-61"><a id="__codelineno-15-61" name="__codelineno-15-61"></a>            <span class="s2">"last_failed_node"</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">last_failed_node</span><span class="p">,</span>
</span><span id="__span-15-62"><a id="__codelineno-15-62" name="__codelineno-15-62"></a>            <span class="s2">"can_retry"</span><span class="p">:</span> <span class="n">ErrorHandler</span><span class="o">.</span><span class="n">should_retry</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="__span-15-63"><a id="__codelineno-15-63" name="__codelineno-15-63"></a>        <span class="p">}</span>
</span><span id="__span-15-64"><a id="__codelineno-15-64" name="__codelineno-15-64"></a>
</span><span id="__span-15-65"><a id="__codelineno-15-65" name="__codelineno-15-65"></a>
</span><span id="__span-15-66"><a id="__codelineno-15-66" name="__codelineno-15-66"></a><span class="k">def</span><span class="w"> </span><span class="nf">handle_node_errors</span><span class="p">(</span><span class="n">node_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">custom_message</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-15-67"><a id="__codelineno-15-67" name="__codelineno-15-67"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
</span><span id="__span-15-68"><a id="__codelineno-15-68" name="__codelineno-15-68"></a>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span id="__span-15-69"><a id="__codelineno-15-69" name="__codelineno-15-69"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">StateType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-15-70"><a id="__codelineno-15-70" name="__codelineno-15-70"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-15-71"><a id="__codelineno-15-71" name="__codelineno-15-71"></a>                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="__span-15-72"><a id="__codelineno-15-72" name="__codelineno-15-72"></a>                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-15-73"><a id="__codelineno-15-73" name="__codelineno-15-73"></a>                    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-15-74"><a id="__codelineno-15-74" name="__codelineno-15-74"></a>                <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ErrorHandler</span><span class="o">.</span><span class="n">clear_errors</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
</span><span id="__span-15-75"><a id="__codelineno-15-75" name="__codelineno-15-75"></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-15-76"><a id="__codelineno-15-76" name="__codelineno-15-76"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-15-77"><a id="__codelineno-15-77" name="__codelineno-15-77"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error in async node '</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
</span><span id="__span-15-78"><a id="__codelineno-15-78" name="__codelineno-15-78"></a>                <span class="k">return</span> <span class="n">ErrorHandler</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">custom_message</span><span class="p">)</span>
</span><span id="__span-15-79"><a id="__codelineno-15-79" name="__codelineno-15-79"></a>
</span><span id="__span-15-80"><a id="__codelineno-15-80" name="__codelineno-15-80"></a>        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span id="__span-15-81"><a id="__codelineno-15-81" name="__codelineno-15-81"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">sync_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">StateType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-15-82"><a id="__codelineno-15-82" name="__codelineno-15-82"></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="__span-15-83"><a id="__codelineno-15-83" name="__codelineno-15-83"></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span><span id="__span-15-84"><a id="__codelineno-15-84" name="__codelineno-15-84"></a>                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-15-85"><a id="__codelineno-15-85" name="__codelineno-15-85"></a>                    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="__span-15-86"><a id="__codelineno-15-86" name="__codelineno-15-86"></a>                <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ErrorHandler</span><span class="o">.</span><span class="n">clear_errors</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
</span><span id="__span-15-87"><a id="__codelineno-15-87" name="__codelineno-15-87"></a>                <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-15-88"><a id="__codelineno-15-88" name="__codelineno-15-88"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-15-89"><a id="__codelineno-15-89" name="__codelineno-15-89"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error in sync node '</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
</span><span id="__span-15-90"><a id="__codelineno-15-90" name="__codelineno-15-90"></a>                <span class="k">return</span> <span class="n">ErrorHandler</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">custom_message</span><span class="p">)</span>
</span><span id="__span-15-91"><a id="__codelineno-15-91" name="__codelineno-15-91"></a>
</span><span id="__span-15-92"><a id="__codelineno-15-92" name="__codelineno-15-92"></a>        <span class="k">if</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="__span-15-93"><a id="__codelineno-15-93" name="__codelineno-15-93"></a>            <span class="k">return</span> <span class="n">async_wrapper</span>
</span><span id="__span-15-94"><a id="__codelineno-15-94" name="__codelineno-15-94"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-95"><a id="__codelineno-15-95" name="__codelineno-15-95"></a>            <span class="k">return</span> <span class="n">sync_wrapper</span>
</span><span id="__span-15-96"><a id="__codelineno-15-96" name="__codelineno-15-96"></a>
</span><span id="__span-15-97"><a id="__codelineno-15-97" name="__codelineno-15-97"></a>    <span class="k">return</span> <span class="n">decorator</span>
</span><span id="__span-15-98"><a id="__codelineno-15-98" name="__codelineno-15-98"></a>
</span><span id="__span-15-99"><a id="__codelineno-15-99" name="__codelineno-15-99"></a>
</span><span id="__span-15-100"><a id="__codelineno-15-100" name="__codelineno-15-100"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-15-101"><a id="__codelineno-15-101" name="__codelineno-15-101"></a><span class="c1"># STATE DEFINITION</span>
</span><span id="__span-15-102"><a id="__codelineno-15-102" name="__codelineno-15-102"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-15-103"><a id="__codelineno-15-103" name="__codelineno-15-103"></a>
</span><span id="__span-15-104"><a id="__codelineno-15-104" name="__codelineno-15-104"></a><span class="k">class</span><span class="w"> </span><span class="nc">ResearchState</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span id="__span-15-105"><a id="__codelineno-15-105" name="__codelineno-15-105"></a><span class="w">    </span><span class="sd">"""State for the research assistant workflow"""</span>
</span><span id="__span-15-106"><a id="__codelineno-15-106" name="__codelineno-15-106"></a>    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
</span><span id="__span-15-107"><a id="__codelineno-15-107" name="__codelineno-15-107"></a>    <span class="n">research_plan</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
</span><span id="__span-15-108"><a id="__codelineno-15-108" name="__codelineno-15-108"></a>    <span class="n">search_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="__span-15-109"><a id="__codelineno-15-109" name="__codelineno-15-109"></a>    <span class="n">summary</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
</span><span id="__span-15-110"><a id="__codelineno-15-110" name="__codelineno-15-110"></a>    <span class="n">final_report</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">""</span>
</span><span id="__span-15-111"><a id="__codelineno-15-111" name="__codelineno-15-111"></a>
</span><span id="__span-15-112"><a id="__codelineno-15-112" name="__codelineno-15-112"></a>    <span class="c1"># Error handling fields</span>
</span><span id="__span-15-113"><a id="__codelineno-15-113" name="__codelineno-15-113"></a>    <span class="n">error_messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="__span-15-114"><a id="__codelineno-15-114" name="__codelineno-15-114"></a>    <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-15-115"><a id="__codelineno-15-115" name="__codelineno-15-115"></a>    <span class="n">max_retries</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="__span-15-116"><a id="__codelineno-15-116" name="__codelineno-15-116"></a>    <span class="n">last_failed_node</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-15-117"><a id="__codelineno-15-117" name="__codelineno-15-117"></a>    <span class="n">current_node</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-15-118"><a id="__codelineno-15-118" name="__codelineno-15-118"></a>
</span><span id="__span-15-119"><a id="__codelineno-15-119" name="__codelineno-15-119"></a>    <span class="c1"># Control flow</span>
</span><span id="__span-15-120"><a id="__codelineno-15-120" name="__codelineno-15-120"></a>    <span class="n">should_continue</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-15-121"><a id="__codelineno-15-121" name="__codelineno-15-121"></a>
</span><span id="__span-15-122"><a id="__codelineno-15-122" name="__codelineno-15-122"></a>    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
</span><span id="__span-15-123"><a id="__codelineno-15-123" name="__codelineno-15-123"></a>        <span class="n">arbitrary_types_allowed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-15-124"><a id="__codelineno-15-124" name="__codelineno-15-124"></a>
</span><span id="__span-15-125"><a id="__codelineno-15-125" name="__codelineno-15-125"></a>
</span><span id="__span-15-126"><a id="__codelineno-15-126" name="__codelineno-15-126"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-15-127"><a id="__codelineno-15-127" name="__codelineno-15-127"></a><span class="c1"># RESEARCH NODES</span>
</span><span id="__span-15-128"><a id="__codelineno-15-128" name="__codelineno-15-128"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-15-129"><a id="__codelineno-15-129" name="__codelineno-15-129"></a>
</span><span id="__span-15-130"><a id="__codelineno-15-130" name="__codelineno-15-130"></a><span class="k">class</span><span class="w"> </span><span class="nc">ResearchNodes</span><span class="p">:</span>
</span><span id="__span-15-131"><a id="__codelineno-15-131" name="__codelineno-15-131"></a><span class="w">    </span><span class="sd">"""Collection of nodes for the research workflow"""</span>
</span><span id="__span-15-132"><a id="__codelineno-15-132" name="__codelineno-15-132"></a>
</span><span id="__span-15-133"><a id="__codelineno-15-133" name="__codelineno-15-133"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ChatOllama</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="__span-15-134"><a id="__codelineno-15-134" name="__codelineno-15-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">llm</span> <span class="ow">or</span> <span class="n">ChatOllama</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">"gpt-oss"</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-15-135"><a id="__codelineno-15-135" name="__codelineno-15-135"></a>
</span><span id="__span-15-136"><a id="__codelineno-15-136" name="__codelineno-15-136"></a>    <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"validate_query"</span><span class="p">,</span> <span class="s2">"Failed to validate the research query"</span><span class="p">)</span>
</span><span id="__span-15-137"><a id="__codelineno-15-137" name="__codelineno-15-137"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-15-138"><a id="__codelineno-15-138" name="__codelineno-15-138"></a><span class="w">        </span><span class="sd">"""Validate that the query is appropriate for research"""</span>
</span><span id="__span-15-139"><a id="__codelineno-15-139" name="__codelineno-15-139"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Validating query: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-140"><a id="__codelineno-15-140" name="__codelineno-15-140"></a>
</span><span id="__span-15-141"><a id="__codelineno-15-141" name="__codelineno-15-141"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">query</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="__span-15-142"><a id="__codelineno-15-142" name="__codelineno-15-142"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Query must be at least 5 characters long"</span><span class="p">)</span>
</span><span id="__span-15-143"><a id="__codelineno-15-143" name="__codelineno-15-143"></a>
</span><span id="__span-15-144"><a id="__codelineno-15-144" name="__codelineno-15-144"></a>        <span class="c1"># Simulate potential validation issues</span>
</span><span id="__span-15-145"><a id="__codelineno-15-145" name="__codelineno-15-145"></a>        <span class="k">if</span> <span class="s2">"error"</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="__span-15-146"><a id="__codelineno-15-146" name="__codelineno-15-146"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Query contains forbidden terms"</span><span class="p">)</span>
</span><span id="__span-15-147"><a id="__codelineno-15-147" name="__codelineno-15-147"></a>
</span><span id="__span-15-148"><a id="__codelineno-15-148" name="__codelineno-15-148"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-15-149"><a id="__codelineno-15-149" name="__codelineno-15-149"></a>            <span class="s2">"current_node"</span><span class="p">:</span> <span class="s2">"validate_query"</span><span class="p">,</span>
</span><span id="__span-15-150"><a id="__codelineno-15-150" name="__codelineno-15-150"></a>            <span class="s2">"should_continue"</span><span class="p">:</span> <span class="kc">True</span>
</span><span id="__span-15-151"><a id="__codelineno-15-151" name="__codelineno-15-151"></a>        <span class="p">}</span>
</span><span id="__span-15-152"><a id="__codelineno-15-152" name="__codelineno-15-152"></a>
</span><span id="__span-15-153"><a id="__codelineno-15-153" name="__codelineno-15-153"></a>    <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"create_research_plan"</span><span class="p">,</span> <span class="s2">"Failed to create research plan"</span><span class="p">)</span>
</span><span id="__span-15-154"><a id="__codelineno-15-154" name="__codelineno-15-154"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_research_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-15-155"><a id="__codelineno-15-155" name="__codelineno-15-155"></a><span class="w">        </span><span class="sd">"""Create a research plan based on the query"""</span>
</span><span id="__span-15-156"><a id="__codelineno-15-156" name="__codelineno-15-156"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Creating research plan for: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-157"><a id="__codelineno-15-157" name="__codelineno-15-157"></a>
</span><span id="__span-15-158"><a id="__codelineno-15-158" name="__codelineno-15-158"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-15-159"><a id="__codelineno-15-159" name="__codelineno-15-159"></a>            <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">"You are a research planning assistant. Create a brief 3-step research plan."</span><span class="p">),</span>
</span><span id="__span-15-160"><a id="__codelineno-15-160" name="__codelineno-15-160"></a>            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Create a research plan for: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-161"><a id="__codelineno-15-161" name="__codelineno-15-161"></a>        <span class="p">]</span>
</span><span id="__span-15-162"><a id="__codelineno-15-162" name="__codelineno-15-162"></a>
</span><span id="__span-15-163"><a id="__codelineno-15-163" name="__codelineno-15-163"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span><span id="__span-15-164"><a id="__codelineno-15-164" name="__codelineno-15-164"></a>
</span><span id="__span-15-165"><a id="__codelineno-15-165" name="__codelineno-15-165"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span><span id="__span-15-166"><a id="__codelineno-15-166" name="__codelineno-15-166"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"LLM returned empty research plan"</span><span class="p">)</span>
</span><span id="__span-15-167"><a id="__codelineno-15-167" name="__codelineno-15-167"></a>
</span><span id="__span-15-168"><a id="__codelineno-15-168" name="__codelineno-15-168"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-15-169"><a id="__codelineno-15-169" name="__codelineno-15-169"></a>            <span class="s2">"research_plan"</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
</span><span id="__span-15-170"><a id="__codelineno-15-170" name="__codelineno-15-170"></a>            <span class="s2">"current_node"</span><span class="p">:</span> <span class="s2">"create_research_plan"</span><span class="p">,</span>
</span><span id="__span-15-171"><a id="__codelineno-15-171" name="__codelineno-15-171"></a>            <span class="s2">"should_continue"</span><span class="p">:</span> <span class="kc">True</span>
</span><span id="__span-15-172"><a id="__codelineno-15-172" name="__codelineno-15-172"></a>        <span class="p">}</span>
</span><span id="__span-15-173"><a id="__codelineno-15-173" name="__codelineno-15-173"></a>
</span><span id="__span-15-174"><a id="__codelineno-15-174" name="__codelineno-15-174"></a>    <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"gather_information"</span><span class="p">,</span> <span class="s2">"Failed to gather information"</span><span class="p">)</span>
</span><span id="__span-15-175"><a id="__codelineno-15-175" name="__codelineno-15-175"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">gather_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-15-176"><a id="__codelineno-15-176" name="__codelineno-15-176"></a><span class="w">        </span><span class="sd">"""Simulate gathering information from various sources"""</span>
</span><span id="__span-15-177"><a id="__codelineno-15-177" name="__codelineno-15-177"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Gathering information..."</span><span class="p">)</span>
</span><span id="__span-15-178"><a id="__codelineno-15-178" name="__codelineno-15-178"></a>
</span><span id="__span-15-179"><a id="__codelineno-15-179" name="__codelineno-15-179"></a>        <span class="c1"># Simulate API calls that might fail</span>
</span><span id="__span-15-180"><a id="__codelineno-15-180" name="__codelineno-15-180"></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="__span-15-181"><a id="__codelineno-15-181" name="__codelineno-15-181"></a>
</span><span id="__span-15-182"><a id="__codelineno-15-182" name="__codelineno-15-182"></a>        <span class="c1"># Simulate random failures for demonstration</span>
</span><span id="__span-15-183"><a id="__codelineno-15-183" name="__codelineno-15-183"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
</span><span id="__span-15-184"><a id="__codelineno-15-184" name="__codelineno-15-184"></a>        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>  <span class="c1"># 20% chance of failure</span>
</span><span id="__span-15-185"><a id="__codelineno-15-185" name="__codelineno-15-185"></a>            <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s2">"Failed to connect to research database"</span><span class="p">)</span>
</span><span id="__span-15-186"><a id="__codelineno-15-186" name="__codelineno-15-186"></a>
</span><span id="__span-15-187"><a id="__codelineno-15-187" name="__codelineno-15-187"></a>        <span class="c1"># Simulate search results</span>
</span><span id="__span-15-188"><a id="__codelineno-15-188" name="__codelineno-15-188"></a>        <span class="n">search_results</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-15-189"><a id="__codelineno-15-189" name="__codelineno-15-189"></a>            <span class="sa">f</span><span class="s2">"Research finding 1 about </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-15-190"><a id="__codelineno-15-190" name="__codelineno-15-190"></a>            <span class="sa">f</span><span class="s2">"Research finding 2 about </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-15-191"><a id="__codelineno-15-191" name="__codelineno-15-191"></a>            <span class="sa">f</span><span class="s2">"Research finding 3 about </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
</span><span id="__span-15-192"><a id="__codelineno-15-192" name="__codelineno-15-192"></a>        <span class="p">]</span>
</span><span id="__span-15-193"><a id="__codelineno-15-193" name="__codelineno-15-193"></a>
</span><span id="__span-15-194"><a id="__codelineno-15-194" name="__codelineno-15-194"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-15-195"><a id="__codelineno-15-195" name="__codelineno-15-195"></a>            <span class="s2">"search_results"</span><span class="p">:</span> <span class="n">search_results</span><span class="p">,</span>
</span><span id="__span-15-196"><a id="__codelineno-15-196" name="__codelineno-15-196"></a>            <span class="s2">"current_node"</span><span class="p">:</span> <span class="s2">"gather_information"</span><span class="p">,</span>
</span><span id="__span-15-197"><a id="__codelineno-15-197" name="__codelineno-15-197"></a>            <span class="s2">"should_continue"</span><span class="p">:</span> <span class="kc">True</span>
</span><span id="__span-15-198"><a id="__codelineno-15-198" name="__codelineno-15-198"></a>        <span class="p">}</span>
</span><span id="__span-15-199"><a id="__codelineno-15-199" name="__codelineno-15-199"></a>
</span><span id="__span-15-200"><a id="__codelineno-15-200" name="__codelineno-15-200"></a>    <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"synthesize_findings"</span><span class="p">,</span> <span class="s2">"Failed to synthesize findings"</span><span class="p">)</span>
</span><span id="__span-15-201"><a id="__codelineno-15-201" name="__codelineno-15-201"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">synthesize_findings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-15-202"><a id="__codelineno-15-202" name="__codelineno-15-202"></a><span class="w">        </span><span class="sd">"""Synthesize the gathered information into a summary"""</span>
</span><span id="__span-15-203"><a id="__codelineno-15-203" name="__codelineno-15-203"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Synthesizing findings..."</span><span class="p">)</span>
</span><span id="__span-15-204"><a id="__codelineno-15-204" name="__codelineno-15-204"></a>
</span><span id="__span-15-205"><a id="__codelineno-15-205" name="__codelineno-15-205"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">search_results</span><span class="p">:</span>
</span><span id="__span-15-206"><a id="__codelineno-15-206" name="__codelineno-15-206"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"No search results available to synthesize"</span><span class="p">)</span>
</span><span id="__span-15-207"><a id="__codelineno-15-207" name="__codelineno-15-207"></a>
</span><span id="__span-15-208"><a id="__codelineno-15-208" name="__codelineno-15-208"></a>        <span class="n">findings_text</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">"- </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">search_results</span><span class="p">)</span>
</span><span id="__span-15-209"><a id="__codelineno-15-209" name="__codelineno-15-209"></a>
</span><span id="__span-15-210"><a id="__codelineno-15-210" name="__codelineno-15-210"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-15-211"><a id="__codelineno-15-211" name="__codelineno-15-211"></a>            <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">"You are a research synthesis assistant. Summarize the findings concisely."</span><span class="p">),</span>
</span><span id="__span-15-212"><a id="__codelineno-15-212" name="__codelineno-15-212"></a>            <span class="n">HumanMessage</span><span class="p">(</span>
</span><span id="__span-15-213"><a id="__codelineno-15-213" name="__codelineno-15-213"></a>                <span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Research Plan:</span><span class="se">\n</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">research_plan</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Findings:</span><span class="se">\n</span><span class="si">{</span><span class="n">findings_text</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Provide a brief summary."</span><span class="p">)</span>
</span><span id="__span-15-214"><a id="__codelineno-15-214" name="__codelineno-15-214"></a>        <span class="p">]</span>
</span><span id="__span-15-215"><a id="__codelineno-15-215" name="__codelineno-15-215"></a>
</span><span id="__span-15-216"><a id="__codelineno-15-216" name="__codelineno-15-216"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span><span id="__span-15-217"><a id="__codelineno-15-217" name="__codelineno-15-217"></a>
</span><span id="__span-15-218"><a id="__codelineno-15-218" name="__codelineno-15-218"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-15-219"><a id="__codelineno-15-219" name="__codelineno-15-219"></a>            <span class="s2">"summary"</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
</span><span id="__span-15-220"><a id="__codelineno-15-220" name="__codelineno-15-220"></a>            <span class="s2">"current_node"</span><span class="p">:</span> <span class="s2">"synthesize_findings"</span><span class="p">,</span>
</span><span id="__span-15-221"><a id="__codelineno-15-221" name="__codelineno-15-221"></a>            <span class="s2">"should_continue"</span><span class="p">:</span> <span class="kc">True</span>
</span><span id="__span-15-222"><a id="__codelineno-15-222" name="__codelineno-15-222"></a>        <span class="p">}</span>
</span><span id="__span-15-223"><a id="__codelineno-15-223" name="__codelineno-15-223"></a>
</span><span id="__span-15-224"><a id="__codelineno-15-224" name="__codelineno-15-224"></a>    <span class="nd">@handle_node_errors</span><span class="p">(</span><span class="s2">"generate_report"</span><span class="p">,</span> <span class="s2">"Failed to generate final report"</span><span class="p">)</span>
</span><span id="__span-15-225"><a id="__codelineno-15-225" name="__codelineno-15-225"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ResearchState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-15-226"><a id="__codelineno-15-226" name="__codelineno-15-226"></a><span class="w">        </span><span class="sd">"""Generate the final research report"""</span>
</span><span id="__span-15-227"><a id="__codelineno-15-227" name="__codelineno-15-227"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Generating final report..."</span><span class="p">)</span>
</span><span id="__span-15-228"><a id="__codelineno-15-228" name="__codelineno-15-228"></a>
</span><span id="__span-15-229"><a id="__codelineno-15-229" name="__codelineno-15-229"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-15-230"><a id="__codelineno-15-230" name="__codelineno-15-230"></a>            <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">"You are a report writing assistant. Create a concise final report."</span><span class="p">),</span>
</span><span id="__span-15-231"><a id="__codelineno-15-231" name="__codelineno-15-231"></a>            <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Query: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">query</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Summary: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">summary</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">Create a final report."</span><span class="p">)</span>
</span><span id="__span-15-232"><a id="__codelineno-15-232" name="__codelineno-15-232"></a>        <span class="p">]</span>
</span><span id="__span-15-233"><a id="__codelineno-15-233" name="__codelineno-15-233"></a>
</span><span id="__span-15-234"><a id="__codelineno-15-234" name="__codelineno-15-234"></a>        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span><span id="__span-15-235"><a id="__codelineno-15-235" name="__codelineno-15-235"></a>
</span><span id="__span-15-236"><a id="__codelineno-15-236" name="__codelineno-15-236"></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-15-237"><a id="__codelineno-15-237" name="__codelineno-15-237"></a>            <span class="s2">"final_report"</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
</span><span id="__span-15-238"><a id="__codelineno-15-238" name="__codelineno-15-238"></a>            <span class="s2">"current_node"</span><span class="p">:</span> <span class="s2">"generate_report"</span><span class="p">,</span>
</span><span id="__span-15-239"><a id="__codelineno-15-239" name="__codelineno-15-239"></a>            <span class="s2">"should_continue"</span><span class="p">:</span> <span class="kc">False</span>
</span><span id="__span-15-240"><a id="__codelineno-15-240" name="__codelineno-15-240"></a>        <span class="p">}</span>
</span><span id="__span-15-241"><a id="__codelineno-15-241" name="__codelineno-15-241"></a>
</span><span id="__span-15-242"><a id="__codelineno-15-242" name="__codelineno-15-242"></a>
</span><span id="__span-15-243"><a id="__codelineno-15-243" name="__codelineno-15-243"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-15-244"><a id="__codelineno-15-244" name="__codelineno-15-244"></a><span class="c1"># ROUTING LOGIC</span>
</span><span id="__span-15-245"><a id="__codelineno-15-245" name="__codelineno-15-245"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-15-246"><a id="__codelineno-15-246" name="__codelineno-15-246"></a>
</span><span id="__span-15-247"><a id="__codelineno-15-247" name="__codelineno-15-247"></a>
</span><span id="__span-15-248"><a id="__codelineno-15-248" name="__codelineno-15-248"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">end_node</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">END</span><span class="p">):</span>
</span><span id="__span-15-249"><a id="__codelineno-15-249" name="__codelineno-15-249"></a><span class="w">    </span><span class="sd">"""Create a universal router that handles errors and retries"""</span>
</span><span id="__span-15-250"><a id="__codelineno-15-250" name="__codelineno-15-250"></a>
</span><span id="__span-15-251"><a id="__codelineno-15-251" name="__codelineno-15-251"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-15-252"><a id="__codelineno-15-252" name="__codelineno-15-252"></a>        <span class="c1"># Handle both dict and Pydantic model</span>
</span><span id="__span-15-253"><a id="__codelineno-15-253" name="__codelineno-15-253"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-15-254"><a id="__codelineno-15-254" name="__codelineno-15-254"></a>            <span class="n">error_messages</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'error_messages'</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-15-255"><a id="__codelineno-15-255" name="__codelineno-15-255"></a>            <span class="n">retry_count</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'retry_count'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="__span-15-256"><a id="__codelineno-15-256" name="__codelineno-15-256"></a>            <span class="n">max_retries</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'max_retries'</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="__span-15-257"><a id="__codelineno-15-257" name="__codelineno-15-257"></a>            <span class="n">last_failed_node</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'last_failed_node'</span><span class="p">,</span> <span class="s1">'validate_query'</span><span class="p">)</span>
</span><span id="__span-15-258"><a id="__codelineno-15-258" name="__codelineno-15-258"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-259"><a id="__codelineno-15-259" name="__codelineno-15-259"></a>            <span class="n">error_messages</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">error_messages</span>
</span><span id="__span-15-260"><a id="__codelineno-15-260" name="__codelineno-15-260"></a>            <span class="n">retry_count</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">retry_count</span>
</span><span id="__span-15-261"><a id="__codelineno-15-261" name="__codelineno-15-261"></a>            <span class="n">max_retries</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">max_retries</span>
</span><span id="__span-15-262"><a id="__codelineno-15-262" name="__codelineno-15-262"></a>            <span class="n">last_failed_node</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">last_failed_node</span> <span class="ow">or</span> <span class="s1">'validate_query'</span>
</span><span id="__span-15-263"><a id="__codelineno-15-263" name="__codelineno-15-263"></a>
</span><span id="__span-15-264"><a id="__codelineno-15-264" name="__codelineno-15-264"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error_messages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-15-265"><a id="__codelineno-15-265" name="__codelineno-15-265"></a>            <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&lt;</span> <span class="n">max_retries</span><span class="p">:</span>
</span><span id="__span-15-266"><a id="__codelineno-15-266" name="__codelineno-15-266"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Retrying </span><span class="si">{</span><span class="n">last_failed_node</span><span class="si">}</span><span class="s2">, attempt </span><span class="si">{</span><span class="n">retry_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-267"><a id="__codelineno-15-267" name="__codelineno-15-267"></a>                <span class="k">return</span> <span class="n">last_failed_node</span>
</span><span id="__span-15-268"><a id="__codelineno-15-268" name="__codelineno-15-268"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-269"><a id="__codelineno-15-269" name="__codelineno-15-269"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Max retries reached for </span><span class="si">{</span><span class="n">last_failed_node</span><span class="si">}</span><span class="s2">, ending execution"</span><span class="p">)</span>
</span><span id="__span-15-270"><a id="__codelineno-15-270" name="__codelineno-15-270"></a>                <span class="k">return</span> <span class="n">end_node</span>
</span><span id="__span-15-271"><a id="__codelineno-15-271" name="__codelineno-15-271"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-272"><a id="__codelineno-15-272" name="__codelineno-15-272"></a>            <span class="k">return</span> <span class="n">next_node</span>
</span><span id="__span-15-273"><a id="__codelineno-15-273" name="__codelineno-15-273"></a>
</span><span id="__span-15-274"><a id="__codelineno-15-274" name="__codelineno-15-274"></a>    <span class="k">return</span> <span class="n">router</span>
</span><span id="__span-15-275"><a id="__codelineno-15-275" name="__codelineno-15-275"></a>
</span><span id="__span-15-276"><a id="__codelineno-15-276" name="__codelineno-15-276"></a>
</span><span id="__span-15-277"><a id="__codelineno-15-277" name="__codelineno-15-277"></a><span class="k">def</span><span class="w"> </span><span class="nf">should_retry_node</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-15-278"><a id="__codelineno-15-278" name="__codelineno-15-278"></a><span class="w">    </span><span class="sd">"""Route back to the failed node for retry"""</span>
</span><span id="__span-15-279"><a id="__codelineno-15-279" name="__codelineno-15-279"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-15-280"><a id="__codelineno-15-280" name="__codelineno-15-280"></a>        <span class="n">last_failed</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'last_failed_node'</span><span class="p">,</span> <span class="s1">'validate_query'</span><span class="p">)</span>
</span><span id="__span-15-281"><a id="__codelineno-15-281" name="__codelineno-15-281"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-282"><a id="__codelineno-15-282" name="__codelineno-15-282"></a>        <span class="n">last_failed</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">last_failed_node</span> <span class="ow">or</span> <span class="s1">'validate_query'</span>
</span><span id="__span-15-283"><a id="__codelineno-15-283" name="__codelineno-15-283"></a>
</span><span id="__span-15-284"><a id="__codelineno-15-284" name="__codelineno-15-284"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Routing to retry node: </span><span class="si">{</span><span class="n">last_failed</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-285"><a id="__codelineno-15-285" name="__codelineno-15-285"></a>    <span class="k">return</span> <span class="n">last_failed</span>
</span><span id="__span-15-286"><a id="__codelineno-15-286" name="__codelineno-15-286"></a>
</span><span id="__span-15-287"><a id="__codelineno-15-287" name="__codelineno-15-287"></a>
</span><span id="__span-15-288"><a id="__codelineno-15-288" name="__codelineno-15-288"></a>
</span><span id="__span-15-289"><a id="__codelineno-15-289" name="__codelineno-15-289"></a>
</span><span id="__span-15-290"><a id="__codelineno-15-290" name="__codelineno-15-290"></a>
</span><span id="__span-15-291"><a id="__codelineno-15-291" name="__codelineno-15-291"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-15-292"><a id="__codelineno-15-292" name="__codelineno-15-292"></a><span class="c1"># GRAPH CONSTRUCTION</span>
</span><span id="__span-15-293"><a id="__codelineno-15-293" name="__codelineno-15-293"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-15-294"><a id="__codelineno-15-294" name="__codelineno-15-294"></a>
</span><span id="__span-15-295"><a id="__codelineno-15-295" name="__codelineno-15-295"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_research_graph</span><span class="p">(</span><span class="n">llm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ChatOllama</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompiledStateGraph</span><span class="p">:</span>
</span><span id="__span-15-296"><a id="__codelineno-15-296" name="__codelineno-15-296"></a><span class="w">    </span><span class="sd">"""Create the research assistant graph with error handling"""</span>
</span><span id="__span-15-297"><a id="__codelineno-15-297" name="__codelineno-15-297"></a>
</span><span id="__span-15-298"><a id="__codelineno-15-298" name="__codelineno-15-298"></a>    <span class="n">nodes</span> <span class="o">=</span> <span class="n">ResearchNodes</span><span class="p">(</span><span class="n">llm</span><span class="p">)</span>
</span><span id="__span-15-299"><a id="__codelineno-15-299" name="__codelineno-15-299"></a>
</span><span id="__span-15-300"><a id="__codelineno-15-300" name="__codelineno-15-300"></a>    <span class="c1"># Create the graph</span>
</span><span id="__span-15-301"><a id="__codelineno-15-301" name="__codelineno-15-301"></a>    <span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">ResearchState</span><span class="p">)</span>
</span><span id="__span-15-302"><a id="__codelineno-15-302" name="__codelineno-15-302"></a>
</span><span id="__span-15-303"><a id="__codelineno-15-303" name="__codelineno-15-303"></a>    <span class="c1"># Add nodes</span>
</span><span id="__span-15-304"><a id="__codelineno-15-304" name="__codelineno-15-304"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"validate_query"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">validate_query</span><span class="p">)</span>
</span><span id="__span-15-305"><a id="__codelineno-15-305" name="__codelineno-15-305"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"create_research_plan"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">create_research_plan</span><span class="p">)</span>
</span><span id="__span-15-306"><a id="__codelineno-15-306" name="__codelineno-15-306"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"gather_information"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">gather_information</span><span class="p">)</span>
</span><span id="__span-15-307"><a id="__codelineno-15-307" name="__codelineno-15-307"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"synthesize_findings"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">synthesize_findings</span><span class="p">)</span>
</span><span id="__span-15-308"><a id="__codelineno-15-308" name="__codelineno-15-308"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">"generate_report"</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">generate_report</span><span class="p">)</span>
</span><span id="__span-15-309"><a id="__codelineno-15-309" name="__codelineno-15-309"></a>
</span><span id="__span-15-310"><a id="__codelineno-15-310" name="__codelineno-15-310"></a>    <span class="c1"># Set entry point</span>
</span><span id="__span-15-311"><a id="__codelineno-15-311" name="__codelineno-15-311"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">"validate_query"</span><span class="p">)</span>
</span><span id="__span-15-312"><a id="__codelineno-15-312" name="__codelineno-15-312"></a>
</span><span id="__span-15-313"><a id="__codelineno-15-313" name="__codelineno-15-313"></a>    <span class="c1"># Add conditional edges using universal router</span>
</span><span id="__span-15-314"><a id="__codelineno-15-314" name="__codelineno-15-314"></a>    <span class="c1"># Router will automatically retry the failed node or move to next node</span>
</span><span id="__span-15-315"><a id="__codelineno-15-315" name="__codelineno-15-315"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-15-316"><a id="__codelineno-15-316" name="__codelineno-15-316"></a>        <span class="s2">"validate_query"</span><span class="p">,</span>
</span><span id="__span-15-317"><a id="__codelineno-15-317" name="__codelineno-15-317"></a>        <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="s2">"create_research_plan"</span><span class="p">)</span>
</span><span id="__span-15-318"><a id="__codelineno-15-318" name="__codelineno-15-318"></a>    <span class="p">)</span>
</span><span id="__span-15-319"><a id="__codelineno-15-319" name="__codelineno-15-319"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-15-320"><a id="__codelineno-15-320" name="__codelineno-15-320"></a>        <span class="s2">"create_research_plan"</span><span class="p">,</span>
</span><span id="__span-15-321"><a id="__codelineno-15-321" name="__codelineno-15-321"></a>        <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="s2">"gather_information"</span><span class="p">)</span>
</span><span id="__span-15-322"><a id="__codelineno-15-322" name="__codelineno-15-322"></a>    <span class="p">)</span>
</span><span id="__span-15-323"><a id="__codelineno-15-323" name="__codelineno-15-323"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-15-324"><a id="__codelineno-15-324" name="__codelineno-15-324"></a>        <span class="s2">"gather_information"</span><span class="p">,</span>
</span><span id="__span-15-325"><a id="__codelineno-15-325" name="__codelineno-15-325"></a>        <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="s2">"synthesize_findings"</span><span class="p">)</span>
</span><span id="__span-15-326"><a id="__codelineno-15-326" name="__codelineno-15-326"></a>    <span class="p">)</span>
</span><span id="__span-15-327"><a id="__codelineno-15-327" name="__codelineno-15-327"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-15-328"><a id="__codelineno-15-328" name="__codelineno-15-328"></a>        <span class="s2">"synthesize_findings"</span><span class="p">,</span>
</span><span id="__span-15-329"><a id="__codelineno-15-329" name="__codelineno-15-329"></a>        <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="s2">"generate_report"</span><span class="p">)</span>
</span><span id="__span-15-330"><a id="__codelineno-15-330" name="__codelineno-15-330"></a>    <span class="p">)</span>
</span><span id="__span-15-331"><a id="__codelineno-15-331" name="__codelineno-15-331"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
</span><span id="__span-15-332"><a id="__codelineno-15-332" name="__codelineno-15-332"></a>        <span class="s2">"generate_report"</span><span class="p">,</span>
</span><span id="__span-15-333"><a id="__codelineno-15-333" name="__codelineno-15-333"></a>        <span class="n">create_universal_router</span><span class="p">(</span><span class="n">next_node</span><span class="o">=</span><span class="n">END</span><span class="p">)</span>
</span><span id="__span-15-334"><a id="__codelineno-15-334" name="__codelineno-15-334"></a>    <span class="p">)</span>
</span><span id="__span-15-335"><a id="__codelineno-15-335" name="__codelineno-15-335"></a>
</span><span id="__span-15-336"><a id="__codelineno-15-336" name="__codelineno-15-336"></a>    <span class="k">return</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</span><span id="__span-15-337"><a id="__codelineno-15-337" name="__codelineno-15-337"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-15-338"><a id="__codelineno-15-338" name="__codelineno-15-338"></a><span class="c1"># MAIN EXECUTION</span>
</span><span id="__span-15-339"><a id="__codelineno-15-339" name="__codelineno-15-339"></a><span class="c1"># ============================================================================</span>
</span><span id="__span-15-340"><a id="__codelineno-15-340" name="__codelineno-15-340"></a>
</span><span id="__span-15-341"><a id="__codelineno-15-341" name="__codelineno-15-341"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="__span-15-342"><a id="__codelineno-15-342" name="__codelineno-15-342"></a><span class="w">    </span><span class="sd">"""Run the research assistant"""</span>
</span><span id="__span-15-343"><a id="__codelineno-15-343" name="__codelineno-15-343"></a>
</span><span id="__span-15-344"><a id="__codelineno-15-344" name="__codelineno-15-344"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
</span><span id="__span-15-345"><a id="__codelineno-15-345" name="__codelineno-15-345"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"RESEARCH ASSISTANT WITH ERROR HANDLING"</span><span class="p">)</span>
</span><span id="__span-15-346"><a id="__codelineno-15-346" name="__codelineno-15-346"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
</span><span id="__span-15-347"><a id="__codelineno-15-347" name="__codelineno-15-347"></a>
</span><span id="__span-15-348"><a id="__codelineno-15-348" name="__codelineno-15-348"></a>    <span class="c1"># Create the graph</span>
</span><span id="__span-15-349"><a id="__codelineno-15-349" name="__codelineno-15-349"></a>    <span class="n">graph</span> <span class="o">=</span> <span class="n">create_research_graph</span><span class="p">()</span>
</span><span id="__span-15-350"><a id="__codelineno-15-350" name="__codelineno-15-350"></a>
</span><span id="__span-15-351"><a id="__codelineno-15-351" name="__codelineno-15-351"></a>    <span class="c1"># Test queries</span>
</span><span id="__span-15-352"><a id="__codelineno-15-352" name="__codelineno-15-352"></a>    <span class="n">queries</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-15-353"><a id="__codelineno-15-353" name="__codelineno-15-353"></a>        <span class="s2">"What are the latest developments in quantum computing?"</span><span class="p">,</span>
</span><span id="__span-15-354"><a id="__codelineno-15-354" name="__codelineno-15-354"></a>        <span class="s2">"err"</span><span class="p">,</span>  <span class="c1"># This will fail validation (too short)</span>
</span><span id="__span-15-355"><a id="__codelineno-15-355" name="__codelineno-15-355"></a>        <span class="s2">"Impact of artificial intelligence on healthcare"</span><span class="p">,</span>
</span><span id="__span-15-356"><a id="__codelineno-15-356" name="__codelineno-15-356"></a>    <span class="p">]</span>
</span><span id="__span-15-357"><a id="__codelineno-15-357" name="__codelineno-15-357"></a>
</span><span id="__span-15-358"><a id="__codelineno-15-358" name="__codelineno-15-358"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">query</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="__span-15-359"><a id="__codelineno-15-359" name="__codelineno-15-359"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="si">{</span><span class="s1">'='</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">80</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-360"><a id="__codelineno-15-360" name="__codelineno-15-360"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"QUERY </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-361"><a id="__codelineno-15-361" name="__codelineno-15-361"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="s1">'='</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">80</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-362"><a id="__codelineno-15-362" name="__codelineno-15-362"></a>
</span><span id="__span-15-363"><a id="__codelineno-15-363" name="__codelineno-15-363"></a>        <span class="n">initial_state</span> <span class="o">=</span> <span class="n">ResearchState</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
</span><span id="__span-15-364"><a id="__codelineno-15-364" name="__codelineno-15-364"></a>
</span><span id="__span-15-365"><a id="__codelineno-15-365" name="__codelineno-15-365"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-15-366"><a id="__codelineno-15-366" name="__codelineno-15-366"></a>
</span><span id="__span-15-367"><a id="__codelineno-15-367" name="__codelineno-15-367"></a>            <span class="n">final_state</span> <span class="o">=</span> <span class="k">await</span> <span class="n">graph</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">initial_state</span><span class="p">)</span>
</span><span id="__span-15-368"><a id="__codelineno-15-368" name="__codelineno-15-368"></a>
</span><span id="__span-15-369"><a id="__codelineno-15-369" name="__codelineno-15-369"></a>            <span class="c1"># Display results</span>
</span><span id="__span-15-370"><a id="__codelineno-15-370" name="__codelineno-15-370"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">"="</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
</span><span id="__span-15-371"><a id="__codelineno-15-371" name="__codelineno-15-371"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">"RESULTS"</span><span class="p">)</span>
</span><span id="__span-15-372"><a id="__codelineno-15-372" name="__codelineno-15-372"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">"="</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
</span><span id="__span-15-373"><a id="__codelineno-15-373" name="__codelineno-15-373"></a>
</span><span id="__span-15-374"><a id="__codelineno-15-374" name="__codelineno-15-374"></a>            <span class="c1"># final_state is a dict, not a ResearchState object</span>
</span><span id="__span-15-375"><a id="__codelineno-15-375" name="__codelineno-15-375"></a>            <span class="n">error_messages</span> <span class="o">=</span> <span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"error_messages"</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="__span-15-376"><a id="__codelineno-15-376" name="__codelineno-15-376"></a>
</span><span id="__span-15-377"><a id="__codelineno-15-377" name="__codelineno-15-377"></a>            <span class="k">if</span> <span class="n">error_messages</span><span class="p">:</span>
</span><span id="__span-15-378"><a id="__codelineno-15-378" name="__codelineno-15-378"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">❌ FAILED with errors:"</span><span class="p">)</span>
</span><span id="__span-15-379"><a id="__codelineno-15-379" name="__codelineno-15-379"></a>                <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">error_messages</span><span class="p">:</span>
</span><span id="__span-15-380"><a id="__codelineno-15-380" name="__codelineno-15-380"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-381"><a id="__codelineno-15-381" name="__codelineno-15-381"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Retry count: </span><span class="si">{</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'retry_count'</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'max_retries'</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-382"><a id="__codelineno-15-382" name="__codelineno-15-382"></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-383"><a id="__codelineno-15-383" name="__codelineno-15-383"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">✅ SUCCESS!"</span><span class="p">)</span>
</span><span id="__span-15-384"><a id="__codelineno-15-384" name="__codelineno-15-384"></a>                <span class="n">research_plan</span> <span class="o">=</span> <span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'research_plan'</span><span class="p">,</span> <span class="s1">'N/A'</span><span class="p">)</span>
</span><span id="__span-15-385"><a id="__codelineno-15-385" name="__codelineno-15-385"></a>                <span class="n">summary</span> <span class="o">=</span> <span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'summary'</span><span class="p">,</span> <span class="s1">'N/A'</span><span class="p">)</span>
</span><span id="__span-15-386"><a id="__codelineno-15-386" name="__codelineno-15-386"></a>                <span class="n">final_report</span> <span class="o">=</span> <span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'final_report'</span><span class="p">,</span> <span class="s1">'N/A'</span><span class="p">)</span>
</span><span id="__span-15-387"><a id="__codelineno-15-387" name="__codelineno-15-387"></a>
</span><span id="__span-15-388"><a id="__codelineno-15-388" name="__codelineno-15-388"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Research Plan:</span><span class="se">\n</span><span class="si">{</span><span class="n">research_plan</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">research_plan</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">'N/A'</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">research_plan</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>
</span><span id="__span-15-389"><a id="__codelineno-15-389" name="__codelineno-15-389"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Summary:</span><span class="se">\n</span><span class="si">{</span><span class="n">summary</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">summary</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">'N/A'</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">summary</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>
</span><span id="__span-15-390"><a id="__codelineno-15-390" name="__codelineno-15-390"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Final Report:</span><span class="se">\n</span><span class="si">{</span><span class="n">final_report</span><span class="p">[:</span><span class="mi">300</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">final_report</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">'N/A'</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">final_report</span><span class="si">}</span><span class="s2">..."</span><span class="p">)</span>
</span><span id="__span-15-391"><a id="__codelineno-15-391" name="__codelineno-15-391"></a>
</span><span id="__span-15-392"><a id="__codelineno-15-392" name="__codelineno-15-392"></a>            <span class="c1"># Show error summary (convert dict to object-like for ErrorHandler)</span>
</span><span id="__span-15-393"><a id="__codelineno-15-393" name="__codelineno-15-393"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Error Summary:"</span><span class="p">)</span>
</span><span id="__span-15-394"><a id="__codelineno-15-394" name="__codelineno-15-394"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Has errors: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">error_messages</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-395"><a id="__codelineno-15-395" name="__codelineno-15-395"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Error count: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">error_messages</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-396"><a id="__codelineno-15-396" name="__codelineno-15-396"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Retry count: </span><span class="si">{</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'retry_count'</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-397"><a id="__codelineno-15-397" name="__codelineno-15-397"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  - Last failed node: </span><span class="si">{</span><span class="n">final_state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'last_failed_node'</span><span class="p">,</span><span class="w"> </span><span class="s1">'None'</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-398"><a id="__codelineno-15-398" name="__codelineno-15-398"></a>
</span><span id="__span-15-399"><a id="__codelineno-15-399" name="__codelineno-15-399"></a>
</span><span id="__span-15-400"><a id="__codelineno-15-400" name="__codelineno-15-400"></a>
</span><span id="__span-15-401"><a id="__codelineno-15-401" name="__codelineno-15-401"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-15-402"><a id="__codelineno-15-402" name="__codelineno-15-402"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">❌ Unexpected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-15-403"><a id="__codelineno-15-403" name="__codelineno-15-403"></a>
</span><span id="__span-15-404"><a id="__codelineno-15-404" name="__codelineno-15-404"></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-15-405"><a id="__codelineno-15-405" name="__codelineno-15-405"></a>
</span><span id="__span-15-406"><a id="__codelineno-15-406" name="__codelineno-15-406"></a>
</span><span id="__span-15-407"><a id="__codelineno-15-407" name="__codelineno-15-407"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
</span><span id="__span-15-408"><a id="__codelineno-15-408" name="__codelineno-15-408"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</span></code></pre></div></td></tr></table></div> </details></div> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button class="md-top md-icon" data-md-component="top" hidden="" type="button"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg> Back to top </button> </main> <footer class="md-footer"> <nav aria-label="Footer" class="md-footer__inner md-grid"> <a aria-label="Previous: LangChain/LangGraph Q&amp;A" class="md-footer__link md-footer__link--prev" href="../../09/langchainlanggraph-qa/"> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg> </div> <div class="md-footer__title"> <span class="md-footer__direction"> Previous </span> <div class="md-ellipsis"> LangChain/LangGraph Q&amp;A </div> </div> </a> <a aria-label="Next: LangGraph Reflection" class="md-footer__link md-footer__link--next" href="../langgraph-reflection/"> <div class="md-footer__title"> <span class="md-footer__direction"> Next </span> <div class="md-ellipsis"> LangGraph Reflection </div> </div> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"></path></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-copyright"> </div> <div class="md-social"> <a class="md-social__link" href="https://github.com/binzhango" rel="noopener" target="_blank" title="github.com"> <svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg> </a> <a class="md-social__link" href="mailto:zhangbinengr@hotmail.com" rel="noopener" target="_blank" title=""> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2"></path></svg> </a> <a class="md-social__link" href="None" rel="noopener" target="_blank" title=""> <svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485 485 0 0 0 404.081 32.03a1.82 1.82 0 0 0-1.923.91 338 338 0 0 0-14.9 30.6 447.9 447.9 0 0 0-134.426 0 310 310 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.7 483.7 0 0 0-119.688 37.107 1.7 1.7 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.02 2.02 0 0 0 .765 1.375 487.7 487.7 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348 348 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321 321 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251 251 0 0 0 9.109-7.137 1.82 1.82 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.81 1.81 0 0 1 1.924.233 235 235 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.4 301.4 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391 391 0 0 0 30.014 48.815 1.86 1.86 0 0 0 2.063.7A486 486 0 0 0 610.7 405.729a1.88 1.88 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541M222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241m195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241"></path></svg> </a> </div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <script id="__config" type="application/json">{"base": "../../..", "features": ["header.autohide", "navigation.footer", "navigation.indexes", "navigation.top", "navigation.path", "navigation.tabs", "navigation.tabs.sticky", "navigation.expand", "navigation.tracking", "content.code.copy", "content.tabs.link", "content.code.annotate", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src="../../../assets/javascripts/bundle.c8b220af.min.js"></script> <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script><script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body> </html>