---
import type { Props } from '@astrojs/starlight/props';
import Default from '@astrojs/starlight/components/Head.astro';
import CodeBlockCopy from './CodeBlockCopy.astro';
import Lightbox from './Lightbox.astro';
import ThemeManager from './ThemeManager.astro';

// Get route data and entry from Astro.locals
const { id, entry } = Astro.locals.starlightRoute;

// Generate OG image URL for this page
const ogImageUrl = new URL(`/og/${id}.png`, Astro.site);

// Get page URL
const pageUrl = new URL(Astro.url.pathname, Astro.site);

// Extract metadata from entry
const title = entry.data.title || 'B~~~~~Z';
const description = entry.data.description || entry.data.excerpt || 'A blog about Python, Kubernetes, Spark, Machine Learning, and more';
const author = entry.data.author || (Array.isArray(entry.data.authors) ? entry.data.authors[0] : entry.data.authors) || 'Bin Zhang';

// Determine content type (article for posts, website for other pages)
const isPost = id.startsWith('posts/');
const ogType = isPost ? 'article' : 'website';

// Get publish date for articles
const publishDate = entry.data.date ? new Date(entry.data.date).toISOString() : undefined;

// Get categories and tags for articles
const categories = entry.data.categories || [];
const tags = entry.data.tags || [];
---

<Default {...Astro.props}>
    <slot />
</Default>

<!-- Theme Manager - handles theme initialization and persistence -->
<ThemeManager defaultTheme="light" />

<!-- Meta description -->
<meta name="description" content={description} />

<!-- Canonical URL -->
<link rel="canonical" href={pageUrl.toString()} />

<!-- Open Graph meta tags -->
<meta property="og:type" content={ogType} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:url" content={pageUrl.toString()} />
<meta property="og:image" content={ogImageUrl.toString()} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:image:alt" content={title} />
<meta property="og:site_name" content="B~~~~~Z" />
<meta property="og:locale" content="en_US" />

{isPost && publishDate && (
    <>
        <meta property="article:published_time" content={publishDate} />
        <meta property="article:author" content={author} />
        {categories.map((category: string) => (
            <meta property="article:section" content={category} />
        ))}
        {tags.map((tag: string) => (
            <meta property="article:tag" content={tag} />
        ))}
    </>
)}

<!-- Twitter Card meta tags -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={title} />
<meta name="twitter:description" content={description} />
<meta name="twitter:image" content={ogImageUrl.toString()} />
<meta name="twitter:image:alt" content={title} />
<meta name="twitter:site" content="@binzhangtw" />
<meta name="twitter:creator" content="@binzhangtw" />

<CodeBlockCopy />
<Lightbox />

<!-- Load Starlight Tabs script -->
<script type="module" src="/node_modules/@astrojs/starlight/user-components/Tabs.astro?astro&type=script&index=0&lang.ts"></script>

<!-- Force theme colors to load after Starlight's CSS -->
<style is:inline>
    /* Force light theme background colors */
    :root[data-theme='light'],
    :root[data-theme='light'] body,
    :root[data-theme='light'] html {
        --sl-color-bg: #f9fafb !important;
        --sl-color-white: #f9fafb !important;
        background-color: #f9fafb !important;
    }
    
    :root[data-theme='light'] .page,
    :root[data-theme='light'] main.main {
        background-color: #f9fafb !important;
    }
    
    /* White content areas in light mode */
    :root[data-theme='light'] .content-panel,
    :root[data-theme='light'] article,
    :root[data-theme='light'] .sl-container {
        background-color: #ffffff !important;
    }
    
    /* Force dark theme background colors */
    :root[data-theme='dark'],
    :root[data-theme='dark'] body,
    :root[data-theme='dark'] html {
        --sl-color-bg: #0a0a0a !important;
        --sl-color-white: #0a0a0a !important;
        background-color: #0a0a0a !important;
    }
    
    :root[data-theme='dark'] .page,
    :root[data-theme='dark'] main.main {
        background-color: #0a0a0a !important;
    }
</style>

{isPost && publishDate && (
    <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "headline": title,
        "description": description,
        "author": {
            "@type": "Person",
            "name": author
        },
        "datePublished": publishDate,
        "dateModified": entry.data.lastUpdated ? new Date(entry.data.lastUpdated).toISOString() : publishDate,
        "image": ogImageUrl.toString(),
        "url": pageUrl.toString(),
        "publisher": {
            "@type": "Organization",
            "name": "B~~~~~Z",
            "logo": {
                "@type": "ImageObject",
                "url": new URL('/assets/favicon.ico', Astro.site).toString()
            }
        },
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": pageUrl.toString()
        },
        "keywords": tags.join(', '),
        "articleSection": categories.join(', ')
    })} />
)}
